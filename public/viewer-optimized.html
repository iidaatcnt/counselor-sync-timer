<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer - ç›¸è«‡å“¡ç”»é¢ - æœ€é©åŒ–ç‰ˆ</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
            min-width: 600px;
            max-width: 800px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .timer-display {
            font-size: 8em;
            font-weight: bold;
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            letter-spacing: 0.05em;
            color: #FFD700;
        }

        .session-info {
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .info-box {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            padding: 15px;
        }

        .info-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .progress-bar {
            margin: 20px 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #45a049 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .status {
            font-size: 1.5em;
            margin: 30px 0;
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: inline-block;
        }

        .status.running {
            background: rgba(76, 175, 80, 0.3);
            animation: pulse 2s infinite;
        }

        .status.paused {
            background: rgba(255, 152, 0, 0.3);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(76, 175, 80, 0); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); }
        }

        .efficiency-stats {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 255, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(0, 255, 0, 0.3);
        }

        .efficiency-title {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .stat-value {
            font-weight: bold;
        }

        .sync-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }

        .sync-indicator.good {
            background: #4CAF50;
        }

        .sync-indicator.warning {
            background: #FF9800;
        }

        .sync-indicator.error {
            background: #f44336;
        }

        .time-up {
            animation: blink 1s infinite;
            color: #ff6b6b;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        .session-end-alert {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 107, 107, 0.9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            font-size: 1.5em;
            font-weight: bold;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: alertPulse 1s infinite;
            display: none;
        }

        @keyframes alertPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SessionTimer - ç›¸è«‡å“¡ç”»é¢ - æœ€é©åŒ–ç‰ˆ</h1>
        
        <div class="timer-display" id="timerDisplay">20:00</div>
        
        <div class="session-info">
            <div class="info-box">
                <div class="info-label">å…¨ä½“æ®‹ã‚Šæ™‚é–“</div>
                <div class="info-value" id="totalRemainingDisplay">02:00:00</div>
            </div>
            
            <div class="info-box">
                <div class="info-label">ã‚»ãƒƒã‚·ãƒ§ãƒ³æ®‹ã‚Šæ™‚é–“</div>
                <div class="info-value" id="sessionRemainingDisplay">20:00</div>
            </div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
        </div>
        
        <div class="status" id="statusDisplay">å¾…æ©Ÿä¸­</div>
        
        <div class="efficiency-stats">
            <div class="efficiency-title">ğŸ“¡ é€šä¿¡åŠ¹ç‡</div>
            <div class="stat-row">
                <span>åŒæœŸé–“éš”:</span>
                <span class="stat-value" id="currentInterval">-</span>
            </div>
            <div class="stat-row">
                <span>äºˆæƒ³APIå‘¼ã³å‡ºã—ï¼ˆ1æ™‚é–“ï¼‰:</span>
                <span class="stat-value" id="estimatedCalls">-</span>
            </div>
            <div class="stat-row">
                <span>æœ€å¾Œã®åŒæœŸ:</span>
                <span class="stat-value" id="lastSync">-<span class="sync-indicator good" id="syncIndicator"></span></span>
            </div>
        </div>
    </div>

    <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ã‚¢ãƒ©ãƒ¼ãƒˆ -->
    <div class="session-end-alert" id="sessionAlert">
        ğŸ”” ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
    </div>

    <script src="/smart-timer-client.js"></script>
    <script>
        // æœ€é©åŒ–ã•ã‚ŒãŸç›¸è«‡å“¡ç”»é¢
        class OptimizedViewerTimer extends SmartTimerClient {
            constructor() {
                super(false); // ç›¸è«‡å“¡ç”»é¢ã¨ã—ã¦åˆæœŸåŒ–
                
                // DOMè¦ç´ 
                this.timerDisplay = document.getElementById('timerDisplay');
                this.totalRemainingDisplay = document.getElementById('totalRemainingDisplay');
                this.sessionRemainingDisplay = document.getElementById('sessionRemainingDisplay');
                this.statusDisplay = document.getElementById('statusDisplay');
                this.progressFill = document.getElementById('progressFill');
                this.sessionAlert = document.getElementById('sessionAlert');
                
                // çµ±è¨ˆè¡¨ç¤ºè¦ç´ 
                this.currentIntervalDisplay = document.getElementById('currentInterval');
                this.estimatedCallsDisplay = document.getElementById('estimatedCalls');
                this.lastSyncDisplay = document.getElementById('lastSync');
                this.syncIndicator = document.getElementById('syncIndicator');
                
                this.startStatsUpdate();
            }
            
            updateDisplay() {
                // ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
                this.timerDisplay.textContent = this.formatTime(this.timerState.remainingSession || 0);
                this.totalRemainingDisplay.textContent = this.formatLongTime(this.timerState.remainingTotal || 0);
                this.sessionRemainingDisplay.textContent = this.formatTime(this.timerState.remainingSession || 0);

                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼
                if (this.timerState.sessionDuration > 0) {
                    const sessionProgress = ((this.timerState.sessionDuration - (this.timerState.remainingSession || 0)) / this.timerState.sessionDuration) * 100;
                    this.progressFill.style.width = Math.min(100, Math.max(0, sessionProgress)) + '%';
                }

                // çŠ¶æ…‹è¡¨ç¤º
                if (this.timerState.isRunning && !this.timerState.isPaused) {
                    this.statusDisplay.textContent = 'å®Ÿè¡Œä¸­';
                    this.statusDisplay.className = 'status running';
                } else if (this.timerState.isPaused) {
                    this.statusDisplay.textContent = 'ä¸€æ™‚åœæ­¢ä¸­';
                    this.statusDisplay.className = 'status paused';
                } else {
                    this.statusDisplay.textContent = 'å¾…æ©Ÿä¸­';
                    this.statusDisplay.className = 'status';
                }

                // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ã®å‡¦ç†
                if (this.timerState.remainingSession === 0 && this.timerState.isRunning) {
                    this.timerDisplay.classList.add('time-up');
                    this.showSessionEndAlert();
                } else {
                    this.timerDisplay.classList.remove('time-up');
                    this.hideSessionEndAlert();
                }
            }
            
            showSessionEndAlert() {
                this.sessionAlert.style.display = 'block';
                this.playSound();
            }
            
            hideSessionEndAlert() {
                this.sessionAlert.style.display = 'none';
            }
            
            playSound() {
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†éŸ³ã®å†ç”Ÿï¼ˆç°¡æ˜“ç‰ˆï¼‰
                try {
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);
                    
                    oscillator.frequency.value = 880;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, context.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.5);
                    
                    oscillator.start(context.currentTime);
                    oscillator.stop(context.currentTime + 0.5);
                } catch (error) {
                    console.log('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', error);
                }
            }
            
            formatTime(milliseconds) {
                const totalSeconds = Math.ceil(milliseconds / 1000);
                const minutes = Math.floor(totalSeconds / 60);
                const seconds = totalSeconds % 60;
                return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }
            
            formatLongTime(milliseconds) {
                const totalSeconds = Math.ceil(milliseconds / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                
                if (hours > 0) {
                    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }
            
            startStatsUpdate() {
                setInterval(() => {
                    this.updateStats();
                }, 1000);
            }
            
            updateStats() {
                const stats = this.getStats();
                
                this.currentIntervalDisplay.textContent = `${stats.currentSyncInterval}ç§’`;
                this.estimatedCallsDisplay.textContent = `${stats.estimatedCallsPerHour}å›`;
                
                if (stats.lastSync) {
                    const secondsAgo = Math.floor((Date.now() - stats.lastSync) / 1000);
                    this.lastSyncDisplay.textContent = `${secondsAgo}ç§’å‰`;
                    
                    // åŒæœŸã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ã®æ›´æ–°
                    if (secondsAgo < stats.currentSyncInterval * 1.5) {
                        this.syncIndicator.className = 'sync-indicator good';
                    } else if (secondsAgo < stats.currentSyncInterval * 3) {
                        this.syncIndicator.className = 'sync-indicator warning';
                    } else {
                        this.syncIndicator.className = 'sync-indicator error';
                    }
                } else {
                    this.lastSyncDisplay.textContent = 'æœªåŒæœŸ';
                    this.syncIndicator.className = 'sync-indicator error';
                }
            }
            
            // ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
            onSyncSuccess() {
                this.updateDisplay();
            }
            
            onSyncError(error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
            }
        }
        
        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        const timerApp = new OptimizedViewerTimer();
    </script>
</body>
</html>