<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer - ç®¡ç†è€…</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 300;
            letter-spacing: 2px;
        }

        .admin-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 1rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .timer-display {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .timer-label {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            opacity: 0.9;
            font-weight: 300;
        }

        .timer-value {
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        /* ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ï¼ˆæœ€é‡è¦ãƒ»ä¸Šéƒ¨ãƒ»å¤§ããï¼‰ */
        .session-timer {
            margin-bottom: 3rem;
            border: 3px solid #FFD700;
            background: rgba(255, 255, 255, 0.15);
        }

        .session-timer .timer-label {
            font-size: 2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .session-timer .timer-value {
            color: #FFD700;
            font-size: 5rem;
        }

        /* å…¨ä½“ã‚¿ã‚¤ãƒãƒ¼ï¼ˆä¸‹éƒ¨ãƒ»å°ã•ãï¼‰ */
        .total-timer .timer-label {
            font-size: 1.3rem;
        }

        .total-timer .timer-value {
            color: #E1BEE7;
            font-size: 3rem;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .control-panel h3 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 300;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .control-button {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .control-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .start-btn {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
        }

        .start-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #40c057, #37b24d);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .pause-btn {
            background: linear-gradient(45deg, #ff8cc8, #ff6b9d);
            color: white;
        }

        .pause-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #ff6b9d, #ff5085);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .reset-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff5252);
            color: white;
        }

        .reset-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #ff5252, #ff4757);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .next-btn {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
        }

        .next-btn:hover:not(:disabled) {
            background: linear-gradient(45deg, #0984e3, #2d3436);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .control-button:active:not(:disabled) {
            transform: scale(0.95);
        }

        .status {
            font-size: 1.2rem;
            margin-top: 1rem;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            opacity: 0.8;
        }

        .paused {
            color: #ff6b6b;
        }

        .running {
            color: #51cf66;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .connected {
            background: rgba(81, 207, 102, 0.8);
            color: white;
        }

        .disconnected {
            background: rgba(255, 107, 107, 0.8);
            color: white;
        }

        .loading {
            background: rgba(255, 193, 7, 0.8);
            color: white;
        }

        /* éŸ³å£°æœ‰åŠ¹åŒ–ãƒœã‚¿ãƒ³ */
        .audio-enable-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(45deg, #ff9800, #f57c00);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .audio-enable-btn:hover {
            transform: translateX(-50%) translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .audio-enable-btn:active {
            transform: translateX(-50%) scale(0.95);
        }

        .audio-enable-btn.hidden {
            display: none;
        }

        /* ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
                margin-bottom: 1.5rem;
            }
            
            .session-timer .timer-value {
                font-size: 3.5rem;
            }
            
            .session-timer .timer-label {
                font-size: 1.6rem;
            }
            
            .total-timer .timer-value {
                font-size: 2.2rem;
            }
            
            .timer-display, .control-panel {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .button-group {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .control-button {
                padding: 0.8rem 1rem;
                font-size: 1rem;
            }

            .audio-enable-btn {
                bottom: 15px;
                padding: 8px 16px;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0 10px;
            }
            
            .session-timer .timer-value {
                font-size: 3rem;
            }
            
            .session-timer .timer-label {
                font-size: 1.4rem;
            }
            
            .total-timer .timer-value {
                font-size: 2rem;
            }
            
            .button-group {
                grid-template-columns: 1fr;
            }

            .audio-enable-btn {
                bottom: 10px;
                padding: 6px 12px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status loading" id="connectionStatus">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
    
    <div class="container">
        <h1>SessionTimer</h1>
        <div class="admin-badge">ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</div>
        
        <!-- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒãƒ¼ã‚’æœ€ä¸Šéƒ¨ã«å¤§ããè¡¨ç¤º -->
        <div class="timer-display session-timer">
            <div class="timer-label">ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
            <div class="timer-value" id="sessionTimer">20:00</div>
        </div>
        
        <!-- å…¨ä½“ã‚¿ã‚¤ãƒãƒ¼ã‚’ä¸‹éƒ¨ã«å°ã•ãè¡¨ç¤º -->
        <div class="timer-display total-timer">
            <div class="timer-label">å…¨ä½“æ®‹ã‚Šæ™‚é–“</div>
            <div class="timer-value" id="totalTimer">02:00:00</div>
        </div>
        
        <div class="control-panel">
            <h3>ã‚¿ã‚¤ãƒãƒ¼æ“ä½œ</h3>
            <div class="button-group">
                <button class="control-button start-btn" id="startBtn">Start</button>
                <button class="control-button pause-btn" id="pauseBtn">Pause</button>
                <button class="control-button reset-btn" id="resetBtn">Reset</button>
                <button class="control-button next-btn" id="nextBtn">Next</button>
            </div>
            
            <div class="status">
                ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: <span id="statusText">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</span>
            </div>
        </div>
    </div>

    <!-- éŸ³å£°æœ‰åŠ¹åŒ–ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ç”¨ï¼‰ -->
    <button class="audio-enable-btn" id="audioEnableBtn">
        ğŸ”Š ç®¡ç†è€…éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    </button>

    <!-- éš ã—éŸ³å£°è¦ç´ ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰ -->
    <audio id="audioElement" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+fyvWExBDuZ2u7Ao" type="audio/wav">
    </audio>

    <script>
        // DOMè¦ç´ ã®å–å¾—
        const totalTimerElement = document.getElementById('totalTimer');
        const sessionTimerElement = document.getElementById('sessionTimer');
        const statusElement = document.getElementById('statusText');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const nextBtn = document.getElementById('nextBtn');
        const audioEnableBtn = document.getElementById('audioEnableBtn');
        const audioElement = document.getElementById('audioElement');
        
        let isConnected = false;
        let pollInterval = null;
        let consecutiveErrors = 0;
        const maxConsecutiveErrors = 3;
        
        // éŸ³å£°é–¢é€£ã®å¤‰æ•°
        let audioContext = null;
        let soundEnabled = false;
        let audioUnlocked = false;
        let previousSessionTime = null;
        let notifiedTimes = new Set();
        
        // å­¦æ ¡ãƒãƒ£ã‚¤ãƒ æ©Ÿèƒ½ã‚’è¿½åŠ 
        let schoolChimeEnabled = false;
        let chimeNotifiedTimes = new Set();

        // ã‚¦ã‚§ã‚¹ãƒˆãƒŸãƒ³ã‚¹ã‚¿ãƒ¼ãƒãƒ£ã‚¤ãƒ ã®éŸ³éš
        const chimeNotes = {
            'E5': 659.25,  // ãƒŸï¼ˆã‚­ãƒ¼ãƒ³ï¼‰
            'C5': 523.25,  // ãƒ‰ï¼ˆã‚³ãƒ¼ãƒ³ï¼‰  
            'D5': 587.33,  // ãƒ¬ï¼ˆã‚«ãƒ¼ãƒ³ï¼‰
            'G4': 392.00   // ã‚½ï¼ˆã‚³ãƒ¼ãƒ³ï¼‰
        };

        // ç®¡ç†è€…ç”¨3æ®µéšãƒãƒ£ã‚¤ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå°‘ã—æ§ãˆã‚ï¼‰
        const chimePatterns = {
            17: { // 3åˆ†å‰
                name: "3åˆ†å‰ãƒãƒ£ã‚¤ãƒ ",
                pattern: [
                    {note: 'E5', duration: 400},
                    {pause: 120},
                    {note: 'C5', duration: 400},
                    {pause: 120},
                    {note: 'D5', duration: 500}
                ],
                message: "ç®¡ç†è€…é€šçŸ¥: æ®‹ã‚Š3åˆ†"
            },
            19: { // 1åˆ†å‰
                name: "1åˆ†å‰äºˆéˆ´",
                pattern: [
                    {note: 'E5', duration: 300},
                    {pause: 80},
                    {note: 'C5', duration: 300},
                    {pause: 80},
                    {note: 'D5', duration: 300},
                    {pause: 80},
                    {note: 'G4', duration: 400}
                ],
                message: "ç®¡ç†è€…é€šçŸ¥: æ®‹ã‚Š1åˆ†"
            },
            20: { // çµ‚äº†
                name: "çµ‚äº†ãƒãƒ£ã‚¤ãƒ ",
                pattern: [
                    {note: 'E5', duration: 500},
                    {pause: 150},
                    {note: 'C5', duration: 500},
                    {pause: 150},
                    {note: 'D5', duration: 500},
                    {pause: 150},
                    {note: 'G4', duration: 800}
                ],
                message: "ç®¡ç†è€…é€šçŸ¥: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†"
            }
        };

        // å­¦æ ¡ãƒãƒ£ã‚¤ãƒ å†ç”Ÿï¼ˆç®¡ç†è€…ç”¨ï¼‰
        async function playSchoolChime(timing) {
            const chimeData = chimePatterns[timing];
            if (!chimeData || !audioContext || !audioUnlocked) return;

            console.log(`ğŸ« ç®¡ç†è€… ${chimeData.name} - ${chimeData.message}`);

            for (let i = 0; i < chimeData.pattern.length; i++) {
                const step = chimeData.pattern[i];
                
                if (step.pause) {
                    await wait(step.pause);
                } else {
                    const frequency = chimeNotes[step.note];
                    const volume = step.volume || 0.08; // ç®¡ç†è€…ç”¨ã¯å°‘ã—é™ã‹
                    await playChimeTone(frequency, step.duration, volume);
                }
            }
        }

        // ãƒãƒ£ã‚¤ãƒ éŸ³ç”Ÿæˆï¼ˆç®¡ç†è€…ç”¨ï¼‰
        async function playChimeTone(frequency, duration, volume = 0.08) {
            if (!audioContext || !audioUnlocked) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            const harmonic1 = audioContext.createOscillator();
            const harmonic2 = audioContext.createOscillator();
            const harmonicGain1 = audioContext.createGain();
            const harmonicGain2 = audioContext.createGain();

            oscillator.connect(gainNode);
            harmonic1.connect(harmonicGain1);
            harmonic2.connect(harmonicGain2);
            gainNode.connect(audioContext.destination);
            harmonicGain1.connect(audioContext.destination);
            harmonicGain2.connect(audioContext.destination);

            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            oscillator.type = 'sine';
            harmonic1.frequency.setValueAtTime(frequency * 2, audioContext.currentTime);
            harmonic1.type = 'sine';
            harmonic2.frequency.setValueAtTime(frequency * 3, audioContext.currentTime);
            harmonic2.type = 'sine';

            const now = audioContext.currentTime;
            const attackTime = 0.02;
            const decayTime = duration / 1000 * 0.3;
            const sustainLevel = volume * 0.6;

            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(volume, now + attackTime);
            gainNode.gain.exponentialRampToValueAtTime(sustainLevel, now + attackTime + decayTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration / 1000);

            harmonicGain1.gain.setValueAtTime(0, now);
            harmonicGain1.gain.linearRampToValueAtTime(volume * 0.25, now + attackTime);
            harmonicGain1.gain.exponentialRampToValueAtTime(0.01, now + duration / 1000);

            harmonicGain2.gain.setValueAtTime(0, now);
            harmonicGain2.gain.linearRampToValueAtTime(volume * 0.12, now + attackTime);
            harmonicGain2.gain.exponentialRampToValueAtTime(0.01, now + duration / 1000);

            oscillator.start(now);
            harmonic1.start(now);
            harmonic2.start(now);

            oscillator.stop(now + duration / 1000);
            harmonic1.stop(now + duration / 1000);
            harmonic2.stop(now + duration / 1000);

            return wait(duration);
        }

        // å¾…æ©Ÿé–¢æ•°
        function wait(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // å­¦æ ¡ãƒãƒ£ã‚¤ãƒ é€šçŸ¥ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…ç”¨ï¼‰
        function checkSchoolChimeNotifications(sessionTime) {
            const elapsedSeconds = 1200 - sessionTime;
            const elapsedMinutes = Math.floor(elapsedSeconds / 60);

            if (!schoolChimeEnabled) return;

            const importantTimings = [17, 19, 20];
            
            importantTimings.forEach(timing => {
                const targetSeconds = timing * 60;
                const isAtTiming = Math.abs(elapsedSeconds - targetSeconds) <= 2;
                const notAlreadyNotified = !chimeNotifiedTimes.has(timing);

                if (isAtTiming && !notAlreadyNotified) {
                    playSchoolChime(timing);
                    chimeNotifiedTimes.add(timing);
                }
            });

            if (sessionTime > 1100 && chimeNotifiedTimes.size > 0) {
                chimeNotifiedTimes.clear();
                console.log('ğŸ”„ ç®¡ç†è€…å­¦æ ¡ãƒãƒ£ã‚¤ãƒ é€šçŸ¥å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ');
            }
        }

        // ç®¡ç†è€…éŸ³å£°æœ‰åŠ¹åŒ–ã‚’å­¦æ ¡ãƒãƒ£ã‚¤ãƒ å¯¾å¿œã«æ›´æ–°
        async function enableAudio() {
            try {
                console.log('ğŸ”Š ç®¡ç†è€…éŸ³å£°æœ‰åŠ¹åŒ–ã‚’é–‹å§‹');
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    console.log('ğŸ”„ AudioContextã‚’å†é–‹ã—ã¾ã—ãŸ');
                }
                
                try {
                    await audioElement.play();
                    audioElement.pause();
                    audioElement.currentTime = 0;
                } catch (e) {
                    console.log('HTML5 Audio unlock failed, but continuing...');
                }
                
                soundEnabled = true;
                schoolChimeEnabled = true;  // å­¦æ ¡ãƒãƒ£ã‚¤ãƒ ã‚‚æœ‰åŠ¹åŒ–
                audioUnlocked = true;
                audioEnableBtn.classList.add('hidden');
                
                // ç®¡ç†è€…ç”¨å­¦æ ¡ãƒãƒ£ã‚¤ãƒ ã®ãƒ†ã‚¹ãƒˆéŸ³ã‚’å†ç”Ÿ
                await wait(500);
                playSchoolChime(17); // 3åˆ†å‰ãƒãƒ£ã‚¤ãƒ ã§ãƒ†ã‚¹ãƒˆ
                
                console.log('âœ… ç®¡ç†è€…éŸ³å£°ã¨å­¦æ ¡ãƒãƒ£ã‚¤ãƒ ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                alert('ç®¡ç†è€…éŸ³å£°é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼\nğŸ« å­¦æ ¡ãƒãƒ£ã‚¤ãƒ æ–¹å¼ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™\n\nâ€¢ æ®‹ã‚Š3åˆ†: 3éŸ³ãƒãƒ£ã‚¤ãƒ \nâ€¢ æ®‹ã‚Š1åˆ†: äºˆéˆ´\nâ€¢ çµ‚äº†: çµ‚äº†ãƒãƒ£ã‚¤ãƒ ');
                
            } catch (error) {
                console.error('ğŸ’¥ éŸ³å£°æœ‰åŠ¹åŒ–ã«å¤±æ•—:', error);
                alert('éŸ³å£°ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é€šçŸ¥ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        console.log('ğŸš€ SessionTimer ç®¡ç†è€…ãƒšãƒ¼ã‚¸ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
        
        // ã‚¹ãƒãƒ›éŸ³å£°å¯¾å¿œï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§éŸ³å£°ã‚’æœ‰åŠ¹åŒ–
        async function enableAudio() {
            try {
                console.log('ğŸ”Š ç®¡ç†è€…éŸ³å£°æœ‰åŠ¹åŒ–ã‚’é–‹å§‹');
                
                // AudioContextã‚’ä½œæˆ
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // iOS Safariã®å ´åˆã€suspendedã®çŠ¶æ…‹ã‹ã‚‰é–‹å§‹ã•ã‚Œã‚‹
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                    console.log('ğŸ”„ AudioContextã‚’å†é–‹ã—ã¾ã—ãŸ');
                }
                
                // HTML5 Audioã§ã‚‚ã‚¢ãƒ³ãƒ­ãƒƒã‚¯
                try {
                    await audioElement.play();
                    audioElement.pause();
                    audioElement.currentTime = 0;
                } catch (e) {
                    console.log('HTML5 Audio unlock failed, but continuing...');
                }
                
                soundEnabled = true;
                audioUnlocked = true;
                audioEnableBtn.classList.add('hidden');
                
                // ãƒ†ã‚¹ãƒˆéŸ³ã‚’å†ç”Ÿ
                playBeep(2, 600, 150);
                
                console.log('âœ… ç®¡ç†è€…éŸ³å£°ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
                alert('ç®¡ç†è€…éŸ³å£°é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸï¼\nã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œæ™‚ã«éŸ³å£°ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚');
                
            } catch (error) {
                console.error('ğŸ’¥ éŸ³å£°æœ‰åŠ¹åŒ–ã«å¤±æ•—:', error);
                alert('éŸ³å£°ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§é€šçŸ¥ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        }
        
        // ãƒ“ãƒ¼ãƒ—éŸ³ã‚’ç”Ÿæˆãƒ»å†ç”Ÿï¼ˆç®¡ç†è€…ç”¨ï¼‰
        function playBeep(count = 1, frequency = 600, duration = 150) {
            if (!soundEnabled || !audioContext || !audioUnlocked) {
                console.warn('âš ï¸ ç®¡ç†è€…éŸ³å£°ãŒç„¡åŠ¹ã¾ãŸã¯æœªåˆæœŸåŒ–ã§ã™');
                return;
            }
            
            console.log(`ğŸ”” ç®¡ç†è€…ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿ: ${count}å›, ${frequency}Hz, ${duration}ms`);
            
            const playNextBeep = (remaining) => {
                if (remaining <= 0) {
                    console.log('âœ… ç®¡ç†è€…ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿå®Œäº†');
                    return;
                }
                
                try {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    // ç®¡ç†è€…ç”¨ã¯å°‘ã—éŸ³é‡ã‚’ä¸‹ã’ã‚‹
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + duration / 1000);
                    
                    console.log(`ğŸµ ç®¡ç†è€…ãƒ“ãƒ¼ãƒ—éŸ³${count - remaining + 1}å›ç›®å†ç”Ÿ`);
                    
                    // æ¬¡ã®ãƒ“ãƒ¼ãƒ—éŸ³ã‚’250mså¾Œã«å†ç”Ÿ
                    if (remaining > 1) {
                        setTimeout(() => playNextBeep(remaining - 1), 250);
                    }
                } catch (error) {
                    console.error('ğŸ’¥ ãƒ“ãƒ¼ãƒ—éŸ³ã®å†ç”Ÿã«å¤±æ•—:', error);
                }
            };
            
            playNextBeep(count);
        }
        
        // éŸ³å£°é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆç®¡ç†è€…ç”¨ãƒ»ç°¡æ˜“ç‰ˆï¼‰
        function checkAudioNotifications(sessionTime) {
            const elapsedSeconds = 1200 - sessionTime;
            const elapsedMinutes = Math.floor(elapsedSeconds / 60);
            
            if (!soundEnabled) {
                return;
            }
            
            // ç®¡ç†è€…ç”¨ã®é‡è¦ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã¿é€šçŸ¥
            const notifications = [
                { elapsed: 15, beeps: 2, message: 'ç®¡ç†è€…é€šçŸ¥: æ®‹ã‚Š5åˆ†' },
                { elapsed: 19, beeps: 3, message: 'ç®¡ç†è€…é€šçŸ¥: æ®‹ã‚Š1åˆ†' },
                { elapsed: 20, beeps: 4, message: 'ç®¡ç†è€…é€šçŸ¥: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†' }
            ];
            
            notifications.forEach(notification => {
                const targetElapsedSeconds = notification.elapsed * 60;
                const elapsedMatch = Math.abs(elapsedSeconds - targetElapsedSeconds) <= 2;
                const alreadyNotified = notifiedTimes.has(notification.elapsed);
                
                if (elapsedMatch && !alreadyNotified) {
                    console.log(`ğŸ”” ç®¡ç†è€…éŸ³å£°é€šçŸ¥: ${notification.message}`);
                    playBeep(notification.beeps);
                    notifiedTimes.add(notification.elapsed);
                }
            });
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãƒªã‚»ãƒƒãƒˆã•ã‚ŒãŸå ´åˆã€é€šçŸ¥å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
            if (sessionTime > 1100 && notifiedTimes.size > 0) {
                console.log('ğŸ”„ ç®¡ç†è€…é€šçŸ¥å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ');
                notifiedTimes.clear();
            }
        }
        
        // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ¶å¾¡
        function setButtonsEnabled(enabled) {
            startBtn.disabled = !enabled;
            pauseBtn.disabled = !enabled;
            resetBtn.disabled = !enabled;
            nextBtn.disabled = !enabled;
        }
        
        // ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã‚’å–å¾—ã™ã‚‹é–¢æ•°
        async function fetchTimerState() {
            try {
                const response = await fetch('/api/timer', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
                if (!isConnected) {
                    isConnected = true;
                    connectionStatusElement.textContent = 'æ¥ç¶šæ¸ˆã¿';
                    connectionStatusElement.className = 'connection-status connected';
                    setButtonsEnabled(true);
                    consecutiveErrors = 0;
                    console.log('ğŸŒ ç®¡ç†è€…ãŒã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ');
                }
                
                // éŸ³å£°é€šçŸ¥ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ãŒå¤‰åŒ–ã—ãŸå ´åˆã®ã¿ï¼‰
                if (previousSessionTime !== data.sessionTime) {
                    checkAudioNotifications(data.sessionTime);
                    previousSessionTime = data.sessionTime;
                }
                
                // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®æ›´æ–°
                totalTimerElement.textContent = data.totalTimeFormatted;
                sessionTimerElement.textContent = data.sessionTimeFormatted;
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°
                if (data.isPaused) {
                    statusElement.textContent = 'ä¸€æ™‚åœæ­¢ä¸­';
                    statusElement.className = 'paused';
                } else {
                    statusElement.textContent = 'å®Ÿè¡Œä¸­';
                    statusElement.className = 'running';
                }
                
                // ã‚¿ã‚¤ãƒãƒ¼ãŒ0ã«ãªã£ãŸå ´åˆã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                if (data.totalTime === 0) {
                    totalTimerElement.style.color = '#ff6b6b';
                    totalTimerElement.style.animation = 'blink 1s infinite';
                } else {
                    totalTimerElement.style.color = '#E1BEE7';
                    totalTimerElement.style.animation = 'none';
                }
                
                if (data.sessionTime === 0) {
                    sessionTimerElement.style.color = '#ff6b6b';
                    sessionTimerElement.style.animation = 'blink 1s infinite';
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®è¿½åŠ è¦–è¦šåŠ¹æœ
                    document.querySelector('.session-timer').style.borderColor = '#ff6b6b';
                } else {
                    sessionTimerElement.style.color = '#FFD700';
                    sessionTimerElement.style.animation = 'none';
                    document.querySelector('.session-timer').style.borderColor = '#FFD700';
                }
                
            } catch (error) {
                console.error('ğŸ’¥ ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã®å–å¾—ã«å¤±æ•—:', error);
                consecutiveErrors++;
                
                // æ¥ç¶šã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’æ›´æ–°
                if (isConnected || consecutiveErrors >= maxConsecutiveErrors) {
                    isConnected = false;
                    connectionStatusElement.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                    connectionStatusElement.className = 'connection-status disconnected';
                    statusElement.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                    statusElement.className = 'paused';
                    setButtonsEnabled(false);
                }
            }
        }
        
        // APIå‘¼ã³å‡ºã—å…±é€šé–¢æ•°
        async function callTimerAPI(endpoint, action) {
            try {
                setButtonsEnabled(false);
                
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log(`${action}æˆåŠŸ:`, data);
                
                // æ“ä½œæ™‚ã«ç¢ºèªéŸ³ã‚’é³´ã‚‰ã™ï¼ˆéŸ³å£°ãŒæœ‰åŠ¹ãªå ´åˆï¼‰
                if (soundEnabled) {
                    if (action === 'ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹') {
                        playBeep(1, 800, 100); // é«˜éŸ³ã§1å›
                    } else if (action === 'ã‚¿ã‚¤ãƒãƒ¼ä¸€æ™‚åœæ­¢') {
                        playBeep(1, 400, 200); // ä½éŸ³ã§1å›
                    } else if (action === 'ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ') {
                        playBeep(2, 600, 150); // ä¸­éŸ³ã§2å›
                    } else if (action === 'æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³') {
                        playBeep(3, 700, 100); // é«˜ã‚ã®éŸ³ã§3å›
                    }
                }
                
                // å³åº§ã«çŠ¶æ…‹ã‚’æ›´æ–°
                fetchTimerState();
                
            } catch (error) {
                console.error(`${action}ã«å¤±æ•—:`, error);
                alert(`${action}ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            } finally {
                setTimeout(() => setButtonsEnabled(isConnected), 500);
            }
        }
        
        // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
        startBtn.addEventListener('click', () => {
            console.log('Startãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
            callTimerAPI('/api/timer/start', 'ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹');
        });
        
        pauseBtn.addEventListener('click', () => {
            console.log('Pauseãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
            callTimerAPI('/api/timer/pause', 'ã‚¿ã‚¤ãƒãƒ¼ä¸€æ™‚åœæ­¢');
        });
        
        resetBtn.addEventListener('click', () => {
            if (confirm('ã‚¿ã‚¤ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                console.log('Resetãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                callTimerAPI('/api/timer/reset', 'ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ');
            }
        });
        
        nextBtn.addEventListener('click', () => {
            if (confirm('æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«é€²ã¿ã¾ã™ã‹ï¼Ÿ')) {
                console.log('Nextãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚Œã¾ã—ãŸ');
                callTimerAPI('/api/timer/next', 'æ¬¡ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³');
            }
        });
        
        // éŸ³å£°æœ‰åŠ¹åŒ–ãƒœã‚¿ãƒ³
        audioEnableBtn.addEventListener('click', enableAudio);
        
        // å®šæœŸçš„ã«ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã‚’å–å¾—
        function startPolling() {
            console.log('ğŸ”„ ç®¡ç†è€…ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
            fetchTimerState();
            pollInterval = setInterval(fetchTimerState, 1000);
        }
        
        // ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
                console.log('â¹ï¸ ç®¡ç†è€…ã‚¿ã‚¤ãƒãƒ¼ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢');
            }
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“± ç®¡ç†è€…ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            setButtonsEnabled(false);
            startPolling();
        });
        
        // ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‰ã‚Œã‚‹æ™‚ã«ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢
        window.addEventListener('beforeunload', () => {
            console.log('ğŸ‘‹ ç®¡ç†è€…ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã¾ã™');
            stopPolling();
        });

        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
        });
    </script>
</body>
</html>