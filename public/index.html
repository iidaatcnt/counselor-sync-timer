<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #2c5f2d 0%, #1c3d1d 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
            min-width: 450px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .timer-display {
            font-size: 7em;
            font-weight: bold;
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            letter-spacing: 0.05em;
            position: relative;
        }

        .timer-label {
            font-size: 0.15em;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.7;
            letter-spacing: 2px;
        }

        .progress-ring {
            margin: 20px auto;
            width: 200px;
            height: 200px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-circle {
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 8;
            fill: none;
        }

        .progress-ring-path {
            stroke: #4CAF50;
            stroke-width: 8;
            fill: none;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .time-warning {
            stroke: #FFA500 !important;
        }

        .time-critical {
            stroke: #FF4444 !important;
        }

        .status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: inline-block;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .status.disconnected {
            background: rgba(244, 67, 54, 0.3);
        }

        .sync-button {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px 0 rgba(31, 38, 135, 0.2);
            transition: all 0.3s ease;
        }

        .sync-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.4);
        }

        .sync-button:active {
            transform: translateY(0);
        }

        .sync-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .timer-state {
            margin-top: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 1.1em;
        }

        .last-sync {
            margin-top: 10px;
            font-size: 0.9em;
            opacity: 0.7;
        }

        .milestone-indicator {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 0.95em;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-controls {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .time-up {
            animation: blink 1s infinite;
            color: #ff6b6b;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .syncing {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SessionTimer</h1>
        
        <div class="progress-ring">
            <svg>
                <circle class="progress-ring-circle" cx="100" cy="100" r="90"/>
                <circle class="progress-ring-path" id="progressPath" cx="100" cy="100" r="90"/>
            </svg>
        </div>
        
        <div class="timer-display" id="timerDisplay">
            <span class="timer-label">æ®‹ã‚Šæ™‚é–“</span>
            05:00
        </div>
        
        <div class="milestone-indicator" id="milestoneIndicator">
            å¾…æ©Ÿä¸­
        </div>
        
        <div class="status disconnected" id="connectionStatus">æ¥ç¶šä¸­...</div>
        <div class="timer-state" id="timerState">åœæ­¢ä¸­</div>
        
        <div class="sound-controls">
            <span>ğŸ”Š éŸ³å£°æ¡ˆå†…</span>
            <label class="switch">
                <input type="checkbox" id="soundEnabled" checked>
                <span class="slider"></span>
            </label>
            <span id="soundStatus">ON</span>
        </div>
        
        <button class="sync-button" id="soundTestButton" onclick="testSound()">
            ğŸµ éŸ³å£°ãƒ†ã‚¹ãƒˆ
        </button>
        
        <div class="last-sync" id="lastSync">æœ€çµ‚åŒæœŸ: --</div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let timerState = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            totalDuration: 5 * 60 * 1000, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5åˆ†
            remainingTime: 5 * 60 * 1000,
            pausedAt: null
        };

        let displayInterval = null;
        let syncInterval = null;
        let lastSyncTime = null;
        let soundEnabled = true;
        let soundsPlayed = new Set();

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
        const sounds = {
            start: new Audio('/sounds/counselor_start.wav'),
            min10: new Audio('/sounds/counselor_10min.wav'),
            min15: new Audio('/sounds/counselor_15min.wav'),
            min17: new Audio('/sounds/counselor_17min.wav'),
            min18: new Audio('/sounds/counselor_18min.wav'),
            min19: new Audio('/sounds/counselor_19min.wav'),
            end: new Audio('/sounds/counselor_end.wav'),
            test: new Audio('/sounds/counselor_sound_check.wav')
        };

        // è¨­å®š
        const API_BASE_URL = window.location.origin;
        const DISPLAY_UPDATE_INTERVAL = 100;
        const SYNC_INTERVAL = 1000; // 1ç§’ã”ã¨ã«åŒæœŸ

        // DOMè¦ç´ 
        const timerDisplay = document.getElementById('timerDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        const timerStateDisplay = document.getElementById('timerState');
        const lastSyncDisplay = document.getElementById('lastSync');
        const milestoneIndicator = document.getElementById('milestoneIndicator');
        const progressPath = document.getElementById('progressPath');
        const soundCheckbox = document.getElementById('soundEnabled');
        const soundStatusText = document.getElementById('soundStatus');

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã®è¨­å®š
        const radius = 90;
        const circumference = radius * 2 * Math.PI;
        progressPath.style.strokeDasharray = `${circumference} ${circumference}`;
        progressPath.style.strokeDashoffset = 0; // åˆæœŸã¯æº€ã‚¿ãƒ³ï¼ˆã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç”¨ï¼‰

        // éŸ³å£°è¨­å®šã®å¤‰æ›´
        soundCheckbox.addEventListener('change', (e) => {
            soundEnabled = e.target.checked;
            soundStatusText.textContent = soundEnabled ? 'ON' : 'OFF';
        });

        // ã‚¿ã‚¤ãƒãƒ¼è¡¨ç¤ºã®æ›´æ–°
        function updateDisplay() {
            let displayTime;
            let elapsed = 0;
            
            if (timerState.isRunning && !timerState.isPaused) {
                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³è¡¨ç¤ºã®ãŸã‚ã®è¨ˆç®—
                elapsed = Date.now() - timerState.startTime;
                timerState.remainingTime = Math.max(0, timerState.totalDuration - elapsed);
                displayTime = timerState.remainingTime;
                
                // éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ãƒˆãƒªã‚¬ãƒ¼
                checkAndPlaySound(elapsed);
                
                // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤ºã®æ›´æ–°
                updateMilestoneIndicator(elapsed);
            } else if (timerState.isPaused) {
                // ä¸€æ™‚åœæ­¢ä¸­ã¯ä¿å­˜ã•ã‚ŒãŸæ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤º
                displayTime = timerState.remainingTime || timerState.totalDuration;
            } else {
                // åœæ­¢ä¸­ã¯ç·æ™‚é–“ã¾ãŸã¯æ®‹ã‚Šæ™‚é–“ã‚’è¡¨ç¤º
                displayTime = timerState.remainingTime || timerState.totalDuration;
            }

            // NaNãƒã‚§ãƒƒã‚¯
            if (!displayTime || isNaN(displayTime) || displayTime < 0) {
                displayTime = timerState.totalDuration || (5 * 60 * 1000);
            }

            const totalSeconds = Math.ceil(displayTime / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            // NaNãƒã‚§ãƒƒã‚¯
            if (isNaN(minutes) || isNaN(seconds)) {
                timerDisplay.innerHTML = `
                    <span class="timer-label">æ®‹ã‚Šæ™‚é–“</span>
                    05:00
                `;
                return;
            }

            timerDisplay.innerHTML = `
                <span class="timer-label">æ®‹ã‚Šæ™‚é–“</span>
                ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
            `;
            
            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã®æ›´æ–°ï¼ˆtotalDurationãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
            if (timerState.totalDuration && !isNaN(timerState.totalDuration)) {
                updateProgressRing(displayTime, timerState.totalDuration);
            }
            
            // ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ã®è¡¨ç¤º
            if (displayTime === 0 && timerState.isRunning) {
                timerDisplay.classList.add('time-up');
                milestoneIndicator.textContent = 'â° æ™‚é–“çµ‚äº†';
                // è‡ªå‹•åœæ­¢
                timerState.isRunning = false;
            } else {
                timerDisplay.classList.remove('time-up');
            }
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒªãƒ³ã‚°ã®æ›´æ–°
        function updateProgressRing(remaining, total) {
            if (!total || total === 0) return;
            
            const progress = Math.max(0, Math.min(1, remaining / total));
            const offset = circumference - (progress * circumference);
            progressPath.style.strokeDashoffset = offset;
            
            // è‰²ã®å¤‰æ›´
            if (remaining <= 60000) { // 1åˆ†ä»¥ä¸‹
                progressPath.classList.add('time-critical');
                progressPath.classList.remove('time-warning');
            } else if (remaining <= 180000) { // 3åˆ†ä»¥ä¸‹
                progressPath.classList.add('time-warning');
                progressPath.classList.remove('time-critical');
            } else {
                progressPath.classList.remove('time-warning', 'time-critical');
            }
        }

        // ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤ºã®æ›´æ–°
        function updateMilestoneIndicator(elapsed) {
            if (!timerState.totalDuration) return;
            
            const elapsedMinutes = Math.floor(elapsed / 60000);
            const remainingMillis = timerState.totalDuration - elapsed;
            const remainingMinutes = Math.ceil(remainingMillis / 60000);
            
            if (remainingMinutes <= 0) {
                milestoneIndicator.textContent = 'â° æ™‚é–“çµ‚äº†';
            } else if (remainingMinutes === 1) {
                milestoneIndicator.textContent = 'âš ï¸ æ®‹ã‚Š1åˆ† - ã¾ã¨ã‚ã‚’ãŠé¡˜ã„ã—ã¾ã™';
            } else if (remainingMinutes === 2) {
                milestoneIndicator.textContent = 'âš ï¸ æ®‹ã‚Š2åˆ†';
            } else if (remainingMinutes === 3) {
                milestoneIndicator.textContent = 'âš ï¸ æ®‹ã‚Š3åˆ† - ã¾ã¨ã‚ã®æº–å‚™ã‚’';
            } else if (remainingMinutes === 5) {
                milestoneIndicator.textContent = 'ğŸ“ æ®‹ã‚Š5åˆ†';
            } else if (elapsedMinutes === 10) {
                milestoneIndicator.textContent = 'ğŸ“ 10åˆ†çµŒé - æŠ˜ã‚Šè¿”ã—åœ°ç‚¹';
            } else if (elapsedMinutes < 1) {
                milestoneIndicator.textContent = 'ğŸš€ ç›¸è«‡é–‹å§‹';
            } else {
                milestoneIndicator.textContent = `é€²è¡Œä¸­ï¼ˆ${elapsedMinutes}åˆ†çµŒéï¼‰`;
            }
        }

        // éŸ³å£°ã‚¬ã‚¤ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã¨å†ç”Ÿ
        function checkAndPlaySound(elapsed) {
            if (!soundEnabled || !timerState.totalDuration) return;
            
            const elapsedMinutes = elapsed / 60000;
            const totalMinutes = timerState.totalDuration / 60000;
            const remainingMinutes = (timerState.totalDuration - elapsed) / 60000;
            const remainingSeconds = (timerState.totalDuration - elapsed) / 1000;
            
            // é–‹å§‹éŸ³ï¼ˆæœ€åˆã®5ç§’ä»¥å†…ï¼‰- åŒæœŸé…å»¶ã‚’è€ƒæ…®
            if (elapsed < 5000 && !soundsPlayed.has('start')) {
                console.log('é–‹å§‹éŸ³ã‚’å†ç”Ÿã—ã¾ã™');
                playSound('start');
                soundsPlayed.add('start');
            }
            
            // ä¸­é–“åœ°ç‚¹éŸ³ï¼ˆ10åˆ†ä»¥ä¸Šã®ã‚¿ã‚¤ãƒãƒ¼ã®å ´åˆï¼‰
            if (totalMinutes >= 20 && elapsedMinutes >= 10 && elapsedMinutes < 10.1 && !soundsPlayed.has('min10')) {
                console.log('10åˆ†çµŒééŸ³ã‚’å†ç”Ÿã—ã¾ã™');
                playSound('min10');
                soundsPlayed.add('min10');
            }
            
            // æ®‹ã‚Š3åˆ†éŸ³ï¼ˆ15åˆ†éŸ³å£°ã‚’ä½¿ç”¨ï¼‰
            if (remainingMinutes <= 3.1 && remainingMinutes > 2.9 && !soundsPlayed.has('3min_before')) {
                console.log('æ®‹ã‚Š3åˆ†éŸ³ã‚’å†ç”Ÿã—ã¾ã™');
                playSound('min15');
                soundsPlayed.add('3min_before');
            }
            
            // æ®‹ã‚Š2åˆ†éŸ³
            if (remainingMinutes <= 2.1 && remainingMinutes > 1.9 && !soundsPlayed.has('2min_before')) {
                console.log('æ®‹ã‚Š2åˆ†éŸ³ã‚’å†ç”Ÿã—ã¾ã™');
                playSound('min18');
                soundsPlayed.add('2min_before');
            }
            
            // æ®‹ã‚Š1åˆ†éŸ³
            if (remainingMinutes <= 1.1 && remainingMinutes > 0.9 && !soundsPlayed.has('1min_before')) {
                console.log('æ®‹ã‚Š1åˆ†éŸ³ã‚’å†ç”Ÿã—ã¾ã™');
                playSound('min19');
                soundsPlayed.add('1min_before');
            }
            
            // çµ‚äº†éŸ³
            if (remainingSeconds <= 1 && !soundsPlayed.has('end')) {
                console.log('çµ‚äº†éŸ³ã‚’å†ç”Ÿã—ã¾ã™');
                playSound('end');
                soundsPlayed.add('end');
            }
        }

        // éŸ³å£°å†ç”Ÿ
        function playSound(soundKey) {
            if (sounds[soundKey]) {
                sounds[soundKey].play().catch(e => console.log('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
            }
        }

        // éŸ³å£°ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½
        function testSound() {
            if (!soundEnabled) {
                return; // éŸ³å£°OFFã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            }
            
            console.log('éŸ³å£°ãƒ†ã‚¹ãƒˆ: counselor_sound_check.wav ã‚’å†ç”Ÿ');
            
            // ãƒ†ã‚¹ãƒˆå°‚ç”¨éŸ³å£°ã®ã¿ã‚’å†ç”Ÿ
            if (sounds.test) {
                sounds.test.play()
                    .then(() => {
                        console.log('éŸ³å£°ãƒ†ã‚¹ãƒˆå†ç”ŸæˆåŠŸ');
                    })
                    .catch(e => {
                        console.error('éŸ³å£°ãƒ†ã‚¹ãƒˆå†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
                    });
            } else {
                console.error('ãƒ†ã‚¹ãƒˆç”¨éŸ³å£°ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
        }

        // ã‚µãƒ¼ãƒãƒ¼ã¨ã®åŒæœŸ
        async function syncWithServer() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/timer`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log('åŒæœŸãƒ‡ãƒ¼ã‚¿:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                // ã‚µãƒ¼ãƒãƒ¼ã®çŠ¶æ…‹ã§ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚’æ›´æ–°
                const oldState = { ...timerState };
                const wasRunning = oldState.isRunning;
                
                timerState.isRunning = data.isRunning || false;
                timerState.isPaused = data.isPaused || false;
                timerState.startTime = data.startTime || null;
                
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®å€¤ã‚’å„ªå…ˆã—ã€ãªã‘ã‚Œã°ç¾åœ¨ã®å€¤ã‚’ä¿æŒ
                if (data.totalDuration !== undefined && data.totalDuration > 0) {
                    timerState.totalDuration = data.totalDuration;
                    timerState.remainingTime = data.remainingTime || data.totalDuration;
                } else {
                    timerState.totalDuration = oldState.totalDuration || (5 * 60 * 1000);
                    timerState.remainingTime = oldState.remainingTime || (5 * 60 * 1000);
                }
                
                timerState.pausedAt = data.pausedAt || null;
                
                console.log('HTTPåŒæœŸæ›´æ–°:', {
                    totalDuration: timerState.totalDuration,
                    remainingTime: timerState.remainingTime,
                    isRunning: timerState.isRunning
                });
                
                console.log('æ›´æ–°å¾Œã®ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹:', timerState); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                // éŸ³å£°å†ç”Ÿæ¸ˆã¿ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ï¼ˆæ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼‰
                if (!timerState.isRunning) {
                    soundsPlayed.clear();
                } else if (!wasRunning && timerState.isRunning) {
                    // ã‚¿ã‚¤ãƒãƒ¼ãŒæ–°ãŸã«é–‹å§‹ã•ã‚ŒãŸå ´åˆ
                    console.log('æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
                    soundsPlayed.clear();
                    // é–‹å§‹éŸ³ã‚’å†ç”Ÿï¼ˆåŒæœŸã§æ¤œå‡ºã•ã‚ŒãŸå ´åˆï¼‰
                    if (soundEnabled) {
                        console.log('åŒæœŸã«ã‚ˆã‚‹é–‹å§‹éŸ³ã‚’å†ç”Ÿ');
                        setTimeout(() => {
                            playSound('start');
                            soundsPlayed.add('start');
                        }, 100);
                    }
                }

                // æ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°
                connectionStatus.textContent = 'æ¥ç¶šæ¸ˆã¿';
                connectionStatus.className = 'status connected';

                // ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
                if (timerState.isRunning && !timerState.isPaused) {
                    timerStateDisplay.textContent = 'å®Ÿè¡Œä¸­';
                    timerStateDisplay.className = 'timer-state pulse';
                    
                    // å®Ÿè¡Œä¸­ã®å ´åˆã€çµŒéæ™‚é–“ã‚’è¨ˆç®—ã—ã¦ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è¡¨ç¤ºã‚’æ›´æ–°
                    const elapsed = Date.now() - timerState.startTime;
                    updateMilestoneIndicator(elapsed);
                } else if (timerState.isPaused) {
                    timerStateDisplay.textContent = 'ä¸€æ™‚åœæ­¢ä¸­';
                    timerStateDisplay.className = 'timer-state';
                } else {
                    timerStateDisplay.textContent = 'åœæ­¢ä¸­';
                    timerStateDisplay.className = 'timer-state';
                    milestoneIndicator.textContent = 'å¾…æ©Ÿä¸­';
                }

                // è¡¨ç¤ºã‚’æ›´æ–°
                updateDisplay();

                // æœ€çµ‚åŒæœŸæ™‚åˆ»ã‚’æ›´æ–°
                lastSyncTime = new Date();
                updateLastSyncDisplay();
                
            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                connectionStatus.textContent = 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
                connectionStatus.className = 'status disconnected';
            }
        }

        // æœ€çµ‚åŒæœŸæ™‚åˆ»ã®è¡¨ç¤ºã‚’æ›´æ–°
        function updateLastSyncDisplay() {
            if (lastSyncTime) {
                const now = new Date();
                const diff = Math.floor((now - lastSyncTime) / 1000);
                
                if (diff < 60) {
                    lastSyncDisplay.textContent = `æœ€çµ‚åŒæœŸ: ${diff}ç§’å‰`;
                } else if (diff < 3600) {
                    const minutes = Math.floor(diff / 60);
                    lastSyncDisplay.textContent = `æœ€çµ‚åŒæœŸ: ${minutes}åˆ†å‰`;
                } else {
                    const hours = Math.floor(diff / 3600);
                    lastSyncDisplay.textContent = `æœ€çµ‚åŒæœŸ: ${hours}æ™‚é–“å‰`;
                }
            }
        }



        // åˆæœŸåŒ–
        function initialize() {
            // åˆæœŸè¡¨ç¤ºï¼ˆåŒæœŸå‰ï¼‰
            updateDisplay();
            
            // èµ·å‹•æ™‚ã«1å›åŒæœŸ
            syncWithServer();

            // è¡¨ç¤ºã®å®šæœŸæ›´æ–°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«è¨ˆç®—ã®ã¿ï¼‰
            displayInterval = setInterval(updateDisplay, DISPLAY_UPDATE_INTERVAL);
            
            // å®šæœŸçš„ãªHTTPãƒãƒ¼ãƒªãƒ³ã‚°åŒæœŸ
            syncInterval = setInterval(syncWithServer, SYNC_INTERVAL);

            // æœ€çµ‚åŒæœŸæ™‚åˆ»ã®è¡¨ç¤ºã‚’å®šæœŸæ›´æ–°
            setInterval(updateLastSyncDisplay, 10000);
        }

        // ãƒšãƒ¼ã‚¸è¡¨ç¤º/éè¡¨ç¤ºã®å‡¦ç†
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(displayInterval);
                clearInterval(syncInterval);
            } else {
                syncWithServer();
                displayInterval = setInterval(updateDisplay, DISPLAY_UPDATE_INTERVAL);
                syncInterval = setInterval(syncWithServer, SYNC_INTERVAL);
            }
        });


        // åˆæœŸåŒ–å®Ÿè¡Œ
        initialize();
    </script>
</body>
</html>