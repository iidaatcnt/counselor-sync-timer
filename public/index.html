<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #2c5f2d 0%, #1c3d1d 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
            text-align: center;
            min-width: 450px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .timer-display {
            font-size: 7em;
            font-weight: bold;
            margin: 30px 0;
            font-variant-numeric: tabular-nums;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            letter-spacing: 0.05em;
            position: relative;
        }

        .timer-label {
            font-size: 0.15em;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.7;
            letter-spacing: 2px;
        }

        .progress-ring {
            margin: 20px auto;
            width: 200px;
            height: 200px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-ring-circle {
            stroke: rgba(255, 255, 255, 0.2);
            stroke-width: 8;
            fill: none;
        }

        .progress-ring-path {
            stroke: #4CAF50;
            stroke-width: 8;
            fill: none;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
        }

        .time-warning {
            stroke: #FFA500 !important;
        }

        .time-critical {
            stroke: #FF4444 !important;
        }

        .status {
            font-size: 1.2em;
            margin: 20px 0;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            display: inline-block;
        }

        .status.connected {
            background: rgba(76, 175, 80, 0.3);
        }

        .status.disconnected {
            background: rgba(244, 67, 54, 0.3);
        }

        .sync-button {
            margin-top: 20px;
            padding: 12px 24px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px 0 rgba(31, 38, 135, 0.2);
            transition: all 0.3s ease;
        }

        .sync-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(31, 38, 135, 0.4);
        }

        .sync-button:active {
            transform: translateY(0);
        }

        .sync-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .timer-state {
            margin-top: 20px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            font-size: 1.1em;
        }

        .last-sync {
            margin-top: 10px;
            font-size: 0.9em;
            opacity: 0.7;
        }

        .milestone-indicator {
            margin: 15px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            font-size: 0.95em;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-controls {
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: .4s;
            border-radius: 28px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4CAF50;
        }

        input:checked + .slider:before {
            transform: translateX(22px);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .time-up {
            animation: blink 1s infinite;
            color: #ff6b6b;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .syncing {
            display: inline-block;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>SessionTimer</h1>
        
        <div class="progress-ring">
            <svg>
                <circle class="progress-ring-circle" cx="100" cy="100" r="90"/>
                <circle class="progress-ring-path" id="progressPath" cx="100" cy="100" r="90"/>
            </svg>
        </div>
        
        <div class="timer-display" id="timerDisplay">
            <span class="timer-label">ÊÆã„ÇäÊôÇÈñì</span>
            05:00
        </div>
        
        <div class="milestone-indicator" id="milestoneIndicator">
            ÂæÖÊ©ü‰∏≠
        </div>
        
        <div class="status disconnected" id="connectionStatus">Êé•Á∂ö‰∏≠...</div>
        <div class="timer-state" id="timerState">ÂÅúÊ≠¢‰∏≠</div>
        
        <div class="sound-controls">
            <span>üîä Èü≥Â£∞Ê°àÂÜÖ</span>
            <label class="switch">
                <input type="checkbox" id="soundEnabled" checked>
                <span class="slider"></span>
            </label>
            <span id="soundStatus">ON</span>
        </div>
        
        <button class="sync-button" id="soundTestButton" onclick="testSound()">
            üéµ Èü≥Â£∞„ÉÜ„Çπ„Éà
        </button>
        
        <div class="last-sync" id="lastSync">ÊúÄÁµÇÂêåÊúü: --</div>
    </div>

    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let timerState = {
            isRunning: false,
            isPaused: false,
            startTime: null,
            totalDuration: 5 * 60 * 1000, // „Éá„Éï„Ç©„É´„Éà5ÂàÜ
            remainingTime: 5 * 60 * 1000,
            pausedAt: null
        };

        let displayInterval = null;
        let syncInterval = null;
        let lastSyncTime = null;
        let soundEnabled = true;
        let soundsPlayed = new Set();

        // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ„Éó„É™„É≠„Éº„Éâ
        const sounds = {
            start: new Audio('/sounds/counselor_start.wav'),
            min10: new Audio('/sounds/counselor_10min.wav'),
            min15: new Audio('/sounds/counselor_15min.wav'),
            min17: new Audio('/sounds/counselor_17min.wav'),
            min18: new Audio('/sounds/counselor_18min.wav'),
            min19: new Audio('/sounds/counselor_19min.wav'),
            end: new Audio('/sounds/counselor_end.wav'),
            test: new Audio('/sounds/counselor_sound_check.wav')
        };

        // Ë®≠ÂÆö
        const API_BASE_URL = window.location.origin;
        const DISPLAY_UPDATE_INTERVAL = 100;
        const SYNC_INTERVAL = 1000; // 1Áßí„Åî„Å®„Å´ÂêåÊúü

        // DOMË¶ÅÁ¥†
        const timerDisplay = document.getElementById('timerDisplay');
        const connectionStatus = document.getElementById('connectionStatus');
        const timerStateDisplay = document.getElementById('timerState');
        const lastSyncDisplay = document.getElementById('lastSync');
        const milestoneIndicator = document.getElementById('milestoneIndicator');
        const progressPath = document.getElementById('progressPath');
        const soundCheckbox = document.getElementById('soundEnabled');
        const soundStatusText = document.getElementById('soundStatus');

        // „Éó„É≠„Ç∞„É¨„Çπ„É™„É≥„Ç∞„ÅÆË®≠ÂÆö
        const radius = 90;
        const circumference = radius * 2 * Math.PI;
        progressPath.style.strokeDasharray = `${circumference} ${circumference}`;
        progressPath.style.strokeDashoffset = 0; // ÂàùÊúü„ÅØÊ∫Ä„Çø„É≥Ôºà„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Áî®Ôºâ

        // Èü≥Â£∞Ë®≠ÂÆö„ÅÆÂ§âÊõ¥
        soundCheckbox.addEventListener('change', (e) => {
            soundEnabled = e.target.checked;
            soundStatusText.textContent = soundEnabled ? 'ON' : 'OFF';
        });

        // „Çø„Ç§„Éû„ÉºË°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateDisplay() {
            let displayTime;
            let elapsed = 0;
            
            if (timerState.isRunning && !timerState.isPaused) {
                // „Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥Ë°®Á§∫„ÅÆ„Åü„ÇÅ„ÅÆË®àÁÆó
                elapsed = Date.now() - timerState.startTime;
                timerState.remainingTime = Math.max(0, timerState.totalDuration - elapsed);
                displayTime = timerState.remainingTime;
                
                // Èü≥Â£∞„Ç¨„Ç§„Éâ„ÅÆ„Éà„É™„Ç¨„Éº
                checkAndPlaySound(elapsed);
                
                // „Éû„Ç§„É´„Çπ„Éà„Éº„É≥Ë°®Á§∫„ÅÆÊõ¥Êñ∞
                updateMilestoneIndicator(elapsed);
            } else if (timerState.isPaused) {
                // ‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠„ÅØ‰øùÂ≠ò„Åï„Çå„ÅüÊÆã„ÇäÊôÇÈñì„ÇíË°®Á§∫
                displayTime = timerState.remainingTime || timerState.totalDuration;
            } else {
                // ÂÅúÊ≠¢‰∏≠„ÅØÁ∑èÊôÇÈñì„Åæ„Åü„ÅØÊÆã„ÇäÊôÇÈñì„ÇíË°®Á§∫
                displayTime = timerState.remainingTime || timerState.totalDuration;
            }

            // NaN„ÉÅ„Çß„ÉÉ„ÇØ
            if (!displayTime || isNaN(displayTime) || displayTime < 0) {
                displayTime = timerState.totalDuration || (5 * 60 * 1000);
            }

            const totalSeconds = Math.ceil(displayTime / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;

            // NaN„ÉÅ„Çß„ÉÉ„ÇØ
            if (isNaN(minutes) || isNaN(seconds)) {
                timerDisplay.innerHTML = `
                    <span class="timer-label">ÊÆã„ÇäÊôÇÈñì</span>
                    05:00
                `;
                return;
            }

            timerDisplay.innerHTML = `
                <span class="timer-label">ÊÆã„ÇäÊôÇÈñì</span>
                ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}
            `;
            
            // „Éó„É≠„Ç∞„É¨„Çπ„É™„É≥„Ç∞„ÅÆÊõ¥Êñ∞ÔºàtotalDuration„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
            if (timerState.totalDuration && !isNaN(timerState.totalDuration)) {
                updateProgressRing(displayTime, timerState.totalDuration);
            }
            
            // „Çø„Ç§„É†„Ç¢„ÉÉ„Éó„ÅÆË°®Á§∫
            if (displayTime === 0 && timerState.isRunning) {
                timerDisplay.classList.add('time-up');
                milestoneIndicator.textContent = '‚è∞ ÊôÇÈñìÁµÇ‰∫Ü';
                // Ëá™ÂãïÂÅúÊ≠¢
                timerState.isRunning = false;
            } else {
                timerDisplay.classList.remove('time-up');
            }
        }

        // „Éó„É≠„Ç∞„É¨„Çπ„É™„É≥„Ç∞„ÅÆÊõ¥Êñ∞
        function updateProgressRing(remaining, total) {
            if (!total || total === 0) return;
            
            const progress = Math.max(0, Math.min(1, remaining / total));
            const offset = circumference - (progress * circumference);
            progressPath.style.strokeDashoffset = offset;
            
            // Ëâ≤„ÅÆÂ§âÊõ¥
            if (remaining <= 60000) { // 1ÂàÜ‰ª•‰∏ã
                progressPath.classList.add('time-critical');
                progressPath.classList.remove('time-warning');
            } else if (remaining <= 180000) { // 3ÂàÜ‰ª•‰∏ã
                progressPath.classList.add('time-warning');
                progressPath.classList.remove('time-critical');
            } else {
                progressPath.classList.remove('time-warning', 'time-critical');
            }
        }

        // „Éû„Ç§„É´„Çπ„Éà„Éº„É≥Ë°®Á§∫„ÅÆÊõ¥Êñ∞
        function updateMilestoneIndicator(elapsed) {
            if (!timerState.totalDuration) return;
            
            const elapsedMinutes = Math.floor(elapsed / 60000);
            const remainingMillis = timerState.totalDuration - elapsed;
            const remainingMinutes = Math.ceil(remainingMillis / 60000);
            
            if (remainingMinutes <= 0) {
                milestoneIndicator.textContent = '‚è∞ ÊôÇÈñìÁµÇ‰∫Ü';
            } else if (remainingMinutes === 1) {
                milestoneIndicator.textContent = '‚ö†Ô∏è ÊÆã„Çä1ÂàÜ - „Åæ„Å®„ÇÅ„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô';
            } else if (remainingMinutes === 2) {
                milestoneIndicator.textContent = '‚ö†Ô∏è ÊÆã„Çä2ÂàÜ';
            } else if (remainingMinutes === 3) {
                milestoneIndicator.textContent = '‚ö†Ô∏è ÊÆã„Çä3ÂàÜ - „Åæ„Å®„ÇÅ„ÅÆÊ∫ñÂÇô„Çí';
            } else if (remainingMinutes === 5) {
                milestoneIndicator.textContent = 'üìç ÊÆã„Çä5ÂàÜ';
            } else if (elapsedMinutes === 10) {
                milestoneIndicator.textContent = 'üìç 10ÂàÜÁµåÈÅé - Êäò„ÇäËøî„ÅóÂú∞ÁÇπ';
            } else if (elapsedMinutes < 1) {
                milestoneIndicator.textContent = 'üöÄ Áõ∏Ë´áÈñãÂßã';
            } else {
                milestoneIndicator.textContent = `ÈÄ≤Ë°å‰∏≠Ôºà${elapsedMinutes}ÂàÜÁµåÈÅéÔºâ`;
            }
        }

        // Èü≥Â£∞„Ç¨„Ç§„Éâ„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Å®ÂÜçÁîü
        function checkAndPlaySound(elapsed) {
            if (!soundEnabled || !timerState.totalDuration) return;
            
            const elapsedMinutes = elapsed / 60000;
            const totalMinutes = timerState.totalDuration / 60000;
            const remainingMinutes = (timerState.totalDuration - elapsed) / 60000;
            const remainingSeconds = (timerState.totalDuration - elapsed) / 1000;
            
            // ÈñãÂßãÈü≥ÔºàÊúÄÂàù„ÅÆ5Áßí‰ª•ÂÜÖÔºâ- ÂêåÊúüÈÅÖÂª∂„ÇíËÄÉÊÖÆ
            if (elapsed < 5000 && !soundsPlayed.has('start')) {
                console.log('ÈñãÂßãÈü≥„ÇíÂÜçÁîü„Åó„Åæ„Åô');
                playSound('start');
                soundsPlayed.add('start');
            }
            
            // ‰∏≠ÈñìÂú∞ÁÇπÈü≥Ôºà10ÂàÜ‰ª•‰∏ä„ÅÆ„Çø„Ç§„Éû„Éº„ÅÆÂ†¥ÂêàÔºâ
            if (totalMinutes >= 20 && elapsedMinutes >= 10 && elapsedMinutes < 10.1 && !soundsPlayed.has('min10')) {
                console.log('10ÂàÜÁµåÈÅéÈü≥„ÇíÂÜçÁîü„Åó„Åæ„Åô');
                playSound('min10');
                soundsPlayed.add('min10');
            }
            
            // ÊÆã„Çä3ÂàÜÈü≥Ôºà15ÂàÜÈü≥Â£∞„Çí‰ΩøÁî®Ôºâ
            if (remainingMinutes <= 3.1 && remainingMinutes > 2.9 && !soundsPlayed.has('3min_before')) {
                console.log('ÊÆã„Çä3ÂàÜÈü≥„ÇíÂÜçÁîü„Åó„Åæ„Åô');
                playSound('min15');
                soundsPlayed.add('3min_before');
            }
            
            // ÊÆã„Çä2ÂàÜÈü≥
            if (remainingMinutes <= 2.1 && remainingMinutes > 1.9 && !soundsPlayed.has('2min_before')) {
                console.log('ÊÆã„Çä2ÂàÜÈü≥„ÇíÂÜçÁîü„Åó„Åæ„Åô');
                playSound('min18');
                soundsPlayed.add('2min_before');
            }
            
            // ÊÆã„Çä1ÂàÜÈü≥
            if (remainingMinutes <= 1.1 && remainingMinutes > 0.9 && !soundsPlayed.has('1min_before')) {
                console.log('ÊÆã„Çä1ÂàÜÈü≥„ÇíÂÜçÁîü„Åó„Åæ„Åô');
                playSound('min19');
                soundsPlayed.add('1min_before');
            }
            
            // ÁµÇ‰∫ÜÈü≥
            if (remainingSeconds <= 1 && !soundsPlayed.has('end')) {
                console.log('ÁµÇ‰∫ÜÈü≥„ÇíÂÜçÁîü„Åó„Åæ„Åô');
                playSound('end');
                soundsPlayed.add('end');
            }
        }

        // Èü≥Â£∞ÂÜçÁîü
        function playSound(soundKey) {
            if (sounds[soundKey]) {
                sounds[soundKey].play().catch(e => console.log('Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', e));
            }
        }

        // Èü≥Â£∞„ÉÜ„Çπ„ÉàÊ©üËÉΩ
        function testSound() {
            if (!soundEnabled) {
                return; // Èü≥Â£∞OFF„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            }
            
            console.log('Èü≥Â£∞„ÉÜ„Çπ„Éà: counselor_sound_check.wav „ÇíÂÜçÁîü');
            
            // „ÉÜ„Çπ„ÉàÂ∞ÇÁî®Èü≥Â£∞„ÅÆ„Åø„ÇíÂÜçÁîü
            if (sounds.test) {
                sounds.test.play()
                    .then(() => {
                        console.log('Èü≥Â£∞„ÉÜ„Çπ„ÉàÂÜçÁîüÊàêÂäü');
                    })
                    .catch(e => {
                        console.error('Èü≥Â£∞„ÉÜ„Çπ„ÉàÂÜçÁîü„Ç®„É©„Éº:', e);
                    });
            } else {
                console.error('„ÉÜ„Çπ„ÉàÁî®Èü≥Â£∞„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
            }
        }

        // „Çµ„Éº„Éê„Éº„Å®„ÅÆÂêåÊúü
        async function syncWithServer() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/timer`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log('ÂêåÊúü„Éá„Éº„Çø:', data); // „Éá„Éê„ÉÉ„Ç∞Áî®
                
                // „Çµ„Éº„Éê„Éº„ÅÆÁä∂ÊÖã„Åß„É≠„Éº„Ç´„É´Áä∂ÊÖã„ÇíÊõ¥Êñ∞
                const oldState = { ...timerState };
                const wasRunning = oldState.isRunning;
                
                timerState.isRunning = data.isRunning || false;
                timerState.isPaused = data.isPaused || false;
                timerState.startTime = data.startTime || null;
                
                // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆÂÄ§„ÇíÂÑ™ÂÖà„Åó„ÄÅ„Å™„Åë„Çå„Å∞ÁèæÂú®„ÅÆÂÄ§„Çí‰øùÊåÅ
                if (data.totalDuration !== undefined && data.totalDuration > 0) {
                    timerState.totalDuration = data.totalDuration;
                    timerState.remainingTime = data.remainingTime || data.totalDuration;
                } else {
                    timerState.totalDuration = oldState.totalDuration || (5 * 60 * 1000);
                    timerState.remainingTime = oldState.remainingTime || (5 * 60 * 1000);
                }
                
                timerState.pausedAt = data.pausedAt || null;
                
                console.log('HTTPÂêåÊúüÊõ¥Êñ∞:', {
                    totalDuration: timerState.totalDuration,
                    remainingTime: timerState.remainingTime,
                    isRunning: timerState.isRunning
                });
                
                console.log('Êõ¥Êñ∞Âæå„ÅÆ„Çø„Ç§„Éû„ÉºÁä∂ÊÖã:', timerState); // „Éá„Éê„ÉÉ„Ç∞Áî®
                
                // Èü≥Â£∞ÂÜçÁîüÊ∏à„Åø„É™„Çπ„Éà„Çí„ÇØ„É™„Ç¢ÔºàÊñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥Ôºâ
                if (!timerState.isRunning) {
                    soundsPlayed.clear();
                } else if (!wasRunning && timerState.isRunning) {
                    // „Çø„Ç§„Éû„Éº„ÅåÊñ∞„Åü„Å´ÈñãÂßã„Åï„Çå„ÅüÂ†¥Âêà
                    console.log('Êñ∞„Åó„ÅÑ„Çª„ÉÉ„Ç∑„Éß„É≥„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü');
                    soundsPlayed.clear();
                    // ÈñãÂßãÈü≥„ÇíÂÜçÁîüÔºàÂêåÊúü„ÅßÊ§úÂá∫„Åï„Çå„ÅüÂ†¥ÂêàÔºâ
                    if (soundEnabled) {
                        console.log('ÂêåÊúü„Å´„Çà„ÇãÈñãÂßãÈü≥„ÇíÂÜçÁîü');
                        setTimeout(() => {
                            playSound('start');
                            soundsPlayed.add('start');
                        }, 100);
                    }
                }

                // Êé•Á∂öÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
                connectionStatus.textContent = 'Êé•Á∂öÊ∏à„Åø';
                connectionStatus.className = 'status connected';

                // „Çø„Ç§„Éû„ÉºÁä∂ÊÖã„ÅÆË°®Á§∫Êõ¥Êñ∞
                if (timerState.isRunning && !timerState.isPaused) {
                    timerStateDisplay.textContent = 'ÂÆüË°å‰∏≠';
                    timerStateDisplay.className = 'timer-state pulse';
                    
                    // ÂÆüË°å‰∏≠„ÅÆÂ†¥Âêà„ÄÅÁµåÈÅéÊôÇÈñì„ÇíË®àÁÆó„Åó„Å¶„Éû„Ç§„É´„Çπ„Éà„Éº„É≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
                    const elapsed = Date.now() - timerState.startTime;
                    updateMilestoneIndicator(elapsed);
                } else if (timerState.isPaused) {
                    timerStateDisplay.textContent = '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠';
                    timerStateDisplay.className = 'timer-state';
                } else {
                    timerStateDisplay.textContent = 'ÂÅúÊ≠¢‰∏≠';
                    timerStateDisplay.className = 'timer-state';
                    milestoneIndicator.textContent = 'ÂæÖÊ©ü‰∏≠';
                }

                // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                updateDisplay();

                // ÊúÄÁµÇÂêåÊúüÊôÇÂàª„ÇíÊõ¥Êñ∞
                lastSyncTime = new Date();
                updateLastSyncDisplay();
                
            } catch (error) {
                console.error('ÂêåÊúü„Ç®„É©„Éº:', error);
                connectionStatus.textContent = 'Êé•Á∂ö„Ç®„É©„Éº';
                connectionStatus.className = 'status disconnected';
            }
        }

        // ÊúÄÁµÇÂêåÊúüÊôÇÂàª„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
        function updateLastSyncDisplay() {
            if (lastSyncTime) {
                const now = new Date();
                const diff = Math.floor((now - lastSyncTime) / 1000);
                
                if (diff < 60) {
                    lastSyncDisplay.textContent = `ÊúÄÁµÇÂêåÊúü: ${diff}ÁßíÂâç`;
                } else if (diff < 3600) {
                    const minutes = Math.floor(diff / 60);
                    lastSyncDisplay.textContent = `ÊúÄÁµÇÂêåÊúü: ${minutes}ÂàÜÂâç`;
                } else {
                    const hours = Math.floor(diff / 3600);
                    lastSyncDisplay.textContent = `ÊúÄÁµÇÂêåÊúü: ${hours}ÊôÇÈñìÂâç`;
                }
            }
        }



        // ÂàùÊúüÂåñ
        function initialize() {
            // ÂàùÊúüË°®Á§∫ÔºàÂêåÊúüÂâçÔºâ
            updateDisplay();
            
            // Ëµ∑ÂãïÊôÇ„Å´1ÂõûÂêåÊúü
            syncWithServer();

            // Ë°®Á§∫„ÅÆÂÆöÊúüÊõ¥Êñ∞Ôºà„É≠„Éº„Ç´„É´Ë®àÁÆó„ÅÆ„ÅøÔºâ
            displayInterval = setInterval(updateDisplay, DISPLAY_UPDATE_INTERVAL);
            
            // ÂÆöÊúüÁöÑ„Å™HTTP„Éù„Éº„É™„É≥„Ç∞ÂêåÊúü
            syncInterval = setInterval(syncWithServer, SYNC_INTERVAL);

            // ÊúÄÁµÇÂêåÊúüÊôÇÂàª„ÅÆË°®Á§∫„ÇíÂÆöÊúüÊõ¥Êñ∞
            setInterval(updateLastSyncDisplay, 10000);
        }

        // „Éö„Éº„Ç∏Ë°®Á§∫/ÈùûË°®Á§∫„ÅÆÂá¶ÁêÜ
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                clearInterval(displayInterval);
                clearInterval(syncInterval);
            } else {
                syncWithServer();
                displayInterval = setInterval(updateDisplay, DISPLAY_UPDATE_INTERVAL);
                syncInterval = setInterval(syncWithServer, SYNC_INTERVAL);
            }
        });


        // ÂàùÊúüÂåñÂÆüË°å
        initialize();
    </script>
</body>
</html>