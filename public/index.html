<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer - ç›¸è«‡å“¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #43C6AC 0%, #191654 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .connected { 
            background: rgba(76, 175, 80, 0.9);
            border-color: rgba(76, 175, 80, 0.5);
        }
        .connecting { 
            background: rgba(255, 152, 0, 0.9);
            border-color: rgba(255, 152, 0, 0.5);
        }
        .error { 
            background: rgba(244, 67, 54, 0.9);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .timer-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }

        .session-timer {
            font-size: 5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .session-label {
            font-size: 1.5rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .total-timer {
            font-size: 1.8rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .status-display {
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            display: inline-block;
        }

        /* éŸ³å£°é€šçŸ¥ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
        .sound-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 80px;
            height: 40px;
            background: #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active {
            background: #4CAF50;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(40px);
        }

        .sound-label {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .sound-status {
            font-size: 1.3rem;
            font-weight: bold;
            min-width: 80px;
        }

        .sound-status.enabled {
            color: #4CAF50;
        }

        .sound-status.disabled {
            color: #f44336;
        }

        /* éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
        .voice-message {
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.5);
            border-radius: 15px;
            font-size: 1.1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.5s ease;
            max-width: 600px;
        }

        .voice-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ */
        .test-controls {
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .test-btn {
            margin: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .sound-test-btn {
            background: #FF6B35;
            color: white;
        }

        .voice-test-btn {
            background: #9B59B6;
            color: white;
        }

        .debug-btn {
            background: #3498DB;
            color: white;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
        .timer-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .session-timer {
                font-size: 3.5rem;
            }
            
            .session-label {
                font-size: 1.2rem;
            }
            
            .total-timer {
                font-size: 1.4rem;
            }
            
            .sound-toggle-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .toggle-switch {
                width: 70px;
                height: 35px;
            }
            
            .toggle-slider {
                width: 27px;
                height: 27px;
                top: 4px;
                left: 4px;
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(35px);
            }
        }

        @media (max-width: 480px) {
            .session-timer {
                font-size: 2.8rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">æ¥ç¶šä¸­...</div>
    
    <div class="header">
        <h1>ğŸ¯ SessionTimer - ç›¸è«‡å“¡</h1>
    </div>

    <div class="timer-display">
        <div class="session-timer" id="sessionTimer">20:00</div>
        <div class="session-label">ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
        <div class="total-timer">å…¨ä½“æ®‹ã‚Šæ™‚é–“: <span id="totalTimer">02:00:00</span></div>
        
        <div class="status-display">
            <span id="statusText">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ä¸€æ™‚åœæ­¢ä¸­</span>
        </div>

        <!-- éŸ³å£°é€šçŸ¥ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="sound-toggle-container">
            <span class="sound-label">ğŸ™ï¸ éŸ³å£°æ¡ˆå†…</span>
            <div class="toggle-switch" id="soundToggle">
                <div class="toggle-slider"></div>
            </div>
            <span class="sound-status disabled" id="soundStatus">OFF</span>
        </div>

        <!-- éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
        <div class="voice-message" id="voiceMessage"></div>
    </div>

    <div class="test-controls">
        <button class="test-btn voice-test-btn" onclick="testVoice()">ğŸ™ï¸ éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-btn debug-btn" onclick="showDebugInfo()">ğŸ“Š ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
        <button class="test-btn sound-test-btn" onclick="testStartMessage()">â–¶ï¸ é–‹å§‹æ¡ˆå†…ãƒ†ã‚¹ãƒˆ</button>
    </div>

    <script>
        console.log('ğŸš€ SessionTimer ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
        
        // DOMè¦ç´ ã®å–å¾—
        const totalTimerElement = document.getElementById('totalTimer');
        const sessionTimerElement = document.getElementById('sessionTimer');
        const statusElement = document.getElementById('statusText');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const soundToggle = document.getElementById('soundToggle');
        const soundStatus = document.getElementById('soundStatus');
        const voiceMessageElement = document.getElementById('voiceMessage');
        
        let isConnected = false;
        let pollInterval = null;
        let voiceEnabled = false;
        let previousSessionTime = null;
        let previousStatus = null;
        let notifiedTimes = new Set();

        // Web Speech API
        let speechSynthesis = window.speechSynthesis;
        let voiceReady = false;

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        const audioFiles = {
            start: '/sounds/counselor_start.wav',
            min10: '/sounds/counselor_10min.wav',
            min15: '/sounds/counselor_15min.wav',
            min17: '/sounds/counselor_17min.wav',
            min18: '/sounds/counselor_18min.wav',
            min19: '/sounds/counselor_19min.wav',
            min20: '/sounds/counselor_end.wav',
            soundCheck: '/sounds/counselor_sound_check.wav'
        };

        // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿
        const voiceMessages = {
            start: "ã¾ã‚‚ãªãç›¸è«‡è€…ã•ã‚“ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã€‚ç€å¸­ã—ã¦å¾…æ©Ÿã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",
            min10: "10åˆ†ãŒçµŒéã—ã¾ã—ãŸã€‚ç›¸è«‡ã®é€²è¡ŒçŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚",
            min15: "15åˆ†ãŒçµŒéã—ã¾ã—ãŸã€‚æ®‹ã‚Šæ™‚é–“ã¯5åˆ†ã§ã™ã€‚",
            min17: "æ®‹ã‚Šæ™‚é–“ã¯3åˆ†ã§ã™ã€‚ã¾ã¨ã‚ã®æº–å‚™ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",
            min18: "æ®‹ã‚Šæ™‚é–“ã¯2åˆ†ã§ã™ã€‚",
            min19: "æ®‹ã‚Šæ™‚é–“ã¯1åˆ†ã§ã™ã€‚",
            min20: "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚æœ€å¾Œã«å¿˜ã‚Œç‰©ãŒãªã„ã‹ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°å—ä»˜ã«ã¦æ‰¿ã‚Šã¾ã™ã€‚",
            soundCheck: "éŸ³å£°æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ç›¸è«‡é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚"
        };

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®äº‹å‰èª­ã¿è¾¼ã¿
        const audioCache = {};
        
        function preloadAudioFiles() {
            console.log('ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®äº‹å‰èª­ã¿è¾¼ã¿ã‚’é–‹å§‹');
            
            Object.keys(audioFiles).forEach(key => {
                const audio = new Audio();
                audio.preload = 'auto';
                audio.src = audioFiles[key];
                audio.volume = 0.8;
                
                audio.addEventListener('canplaythrough', () => {
                    console.log(`âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${key} (${audioFiles[key]})`);
                });
                
                audio.addEventListener('error', (e) => {
                    console.error(`âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${key} (${audioFiles[key]})`, e);
                });
                
                // èª­ã¿è¾¼ã¿çŠ¶æ³ã‚’å®šæœŸãƒã‚§ãƒƒã‚¯
                audio.addEventListener('loadstart', () => {
                    console.log(`ğŸ”„ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${key}`);
                });
                
                audioCache[key] = audio;
            });
            
            console.log(`ğŸµ ${Object.keys(audioFiles).length}å€‹ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ`);
        }

        // WAVãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹éŸ³å£°å†ç”Ÿ
        function playAudioFile(key, callback = null) {
            if (!voiceEnabled) {
                console.log('ğŸ”‡ éŸ³å£°ç„¡åŠ¹ã®ãŸã‚å†ç”Ÿã‚’ã‚¹ã‚­ãƒƒãƒ—');
                return;
            }

            const audio = audioCache[key];
            if (!audio) {
                console.error(`âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æœªç™»éŒ²: ${key}`);
                console.log('ğŸ”„ Web Speech APIã§ä»£æ›¿å†ç”Ÿ');
                speakJapanese(voiceMessages[key], callback);
                return;
            }

            try {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤º
                showVoiceMessage(voiceMessages[key]);

                // éŸ³å£°å†ç”Ÿã®æº–å‚™
                audio.currentTime = 0; // æœ€åˆã‹ã‚‰å†ç”Ÿ
                
                // éŸ³é‡ç¢ºèª
                if (audio.volume < 0.5) {
                    audio.volume = 0.8;
                    console.log('ğŸ”Š éŸ³é‡ã‚’0.8ã«èª¿æ•´');
                }
                
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log(`ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿé–‹å§‹: ${key} (${audioFiles[key]})`);
                    }).catch((error) => {
                        console.error(`âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${key}`, error);
                        console.log('ğŸ”„ Web Speech APIã§ä»£æ›¿å†ç”Ÿ');
                        speakJapanese(voiceMessages[key], callback);
                    });
                }

                audio.onended = () => {
                    console.log(`âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿå®Œäº†: ${key}`);
                    if (callback) callback();
                };

            } catch (error) {
                console.error(`âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿå¤±æ•—: ${key}`, error);
                console.log('ğŸ”„ Web Speech APIã§ä»£æ›¿å†ç”Ÿ');
                speakJapanese(voiceMessages[key], callback);
            }
        }

        // éŸ³å£°åˆæˆã®åˆæœŸåŒ–
        function initializeVoice() {
            try {
                if ('speechSynthesis' in window) {
                    // æ—¥æœ¬èªéŸ³å£°ã®æº–å‚™
                    const voices = speechSynthesis.getVoices();
                    console.log('ğŸ™ï¸ åˆ©ç”¨å¯èƒ½ãªéŸ³å£°:', voices.length);
                    voiceReady = true;
                    return true;
                } else {
                    console.error('âŒ Web Speech API not supported');
                    return false;
                }
            } catch (error) {
                console.error('âŒ éŸ³å£°åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // æ—¥æœ¬èªéŸ³å£°ã®å†ç”Ÿ
        function speakJapanese(text, callback = null) {
            if (!voiceEnabled || !voiceReady) {
                console.log('ğŸ”‡ éŸ³å£°ç„¡åŠ¹ã¾ãŸã¯æœªå¯¾å¿œ');
                return;
            }

            try {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤º
                showVoiceMessage(text);

                // éŸ³å£°åˆæˆ
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9; // å°‘ã—ã‚†ã£ãã‚Š
                utterance.pitch = 1.0;
                utterance.volume = 0.8;

                // æ—¥æœ¬èªéŸ³å£°ã‚’é¸æŠ
                const voices = speechSynthesis.getVoices();
                const japaneseVoice = voices.find(voice => voice.lang.includes('ja'));
                if (japaneseVoice) {
                    utterance.voice = japaneseVoice;
                }

                utterance.onstart = () => {
                    console.log('ğŸ™ï¸ éŸ³å£°å†ç”Ÿé–‹å§‹:', text);
                };

                utterance.onend = () => {
                    console.log('âœ… éŸ³å£°å†ç”Ÿå®Œäº†');
                    if (callback) callback();
                };

                utterance.onerror = (event) => {
                    console.error('âŒ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', event.error);
                };

                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('âŒ éŸ³å£°å†ç”Ÿå¤±æ•—:', error);
            }
        }

        // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”»é¢è¡¨ç¤º
        function showVoiceMessage(text) {
            voiceMessageElement.textContent = text;
            voiceMessageElement.classList.add('show');
            
            // 5ç§’å¾Œã«éè¡¨ç¤º
            setTimeout(() => {
                voiceMessageElement.classList.remove('show');
            }, 5000);
        }

        // éŸ³å£°é€šçŸ¥ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            updateVoiceUI();
            
            if (voiceEnabled) {
                console.log('ğŸ™ï¸ éŸ³å£°æ¡ˆå†…ã‚’ONã«ã—ã¾ã—ãŸ');
                // éŸ³å£°ONæ™‚ã¯å¿…ãšcounselor_sound_check.wavã‚’å†ç”Ÿ
                setTimeout(() => {
                    if (audioCache['soundCheck']) {
                        console.log('ğŸµ éŸ³å£°ç¢ºèªãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿ: counselor_sound_check.wav');
                        playAudioFile('soundCheck');
                    } else {
                        console.log('âš ï¸ éŸ³å£°ç¢ºèªãƒ•ã‚¡ã‚¤ãƒ«æœªèª­ã¿è¾¼ã¿ - Web Speech APIã§ä»£æ›¿');
                        speakJapanese("éŸ³å£°æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ç›¸è«‡é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚");
                    }
                }, 200); // å°‘ã—é…å»¶ã—ã¦ç¢ºå®Ÿã«å®Ÿè¡Œ
            } else {
                console.log('ğŸ”‡ éŸ³å£°æ¡ˆå†…ã‚’OFFã«ã—ã¾ã—ãŸ');
            }
        }

        // éŸ³å£°UIã®æ›´æ–°
        function updateVoiceUI() {
            if (voiceEnabled) {
                soundToggle.classList.add('active');
                soundStatus.textContent = 'ON';
                soundStatus.className = 'sound-status enabled';
            } else {
                soundToggle.classList.remove('active');
                soundStatus.textContent = 'OFF';
                soundStatus.className = 'sound-status disabled';
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã«åŸºã¥ãéŸ³å£°æ¡ˆå†…
        function checkSessionNotifications(currentSessionTime, isPaused) {
            if (!voiceEnabled) return;

            const elapsedTime = 1200 - currentSessionTime; // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
            
            // é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆçµŒéæ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰
            const notifications = [
                { time: 600, key: 'min10' },   // 10åˆ†çµŒé
                { time: 900, key: 'min15' },   // 15åˆ†çµŒé
                { time: 1020, key: 'min17' },  // 17åˆ†çµŒé
                { time: 1080, key: 'min18' },  // 18åˆ†çµŒé
                { time: 1140, key: 'min19' },  // 19åˆ†çµŒé
                { time: 1200, key: 'min20' }   // 20åˆ†çµŒé
            ];

            notifications.forEach(notification => {
                if (elapsedTime >= notification.time && !notifiedTimes.has(notification.time) && !isPaused) {
                    console.log(`ğŸ”” éŸ³å£°æ¡ˆå†…: ${notification.key}`);
                    playAudioFile(notification.key);
                    notifiedTimes.add(notification.time);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
                    sessionTimerElement.classList.add('timer-pulse');
                    setTimeout(() => {
                        sessionTimerElement.classList.remove('timer-pulse');
                    }, 2000);
                }
            });
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã®æ¤œå‡º
        function checkSessionStart(currentStatus, previousStatus) {
            if (voiceEnabled && previousStatus === 'ä¸€æ™‚åœæ­¢ä¸­' && currentStatus === 'å®Ÿè¡Œä¸­') {
                console.log('ğŸ”” ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’æ¤œå‡ºã—ã¾ã—ãŸ');
                console.log('ğŸµ é–‹å§‹æ¡ˆå†…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿ: counselor_start.wav');
                
                // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚ã¯å¿…ãšcounselor_start.wavã‚’å†ç”Ÿ
                if (audioCache['start']) {
                    playAudioFile('start');
                } else {
                    console.log('âš ï¸ é–‹å§‹æ¡ˆå†…ãƒ•ã‚¡ã‚¤ãƒ«æœªèª­ã¿è¾¼ã¿ - Web Speech APIã§ä»£æ›¿');
                    speakJapanese(voiceMessages.start);
                }
                
                notifiedTimes.clear(); // é€šçŸ¥å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                console.log('ğŸ”„ é€šçŸ¥å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã®æ›´æ–°
        function updateTimerDisplay(data) {
            const currentStatus = data.isPaused ? 'ä¸€æ™‚åœæ­¢ä¸­' : 'å®Ÿè¡Œä¸­';
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã®æ¤œå‡º
            checkSessionStart(currentStatus, previousStatus);
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“é€šçŸ¥ã®ç¢ºèª
            if (data.sessionTime !== previousSessionTime) {
                checkSessionNotifications(data.sessionTime, data.isPaused);
                previousSessionTime = data.sessionTime;
            }
            
            sessionTimerElement.textContent = formatTime(data.sessionTime);
            totalTimerElement.textContent = formatTime(data.totalTime);
            statusElement.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${currentStatus}`;
            
            previousStatus = currentStatus;
        }

        // æ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°
        function updateConnectionStatus(status) {
            connectionStatusElement.className = `connection-status ${status}`;
            connectionStatusElement.textContent = 
                status === 'connected' ? 'æ¥ç¶šæ¸ˆã¿' :
                status === 'connecting' ? 'æ¥ç¶šä¸­...' : 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
        }

        // APIå‘¼ã³å‡ºã—
        async function fetchTimerState() {
            try {
                const response = await fetch('/api/timer');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                updateTimerDisplay(data);
                
                if (!isConnected) {
                    isConnected = true;
                    updateConnectionStatus('connected');
                    console.log('ğŸŒ ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ');
                }
                
                return data;
            } catch (error) {
                console.error('âŒ APIå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                if (isConnected) {
                    isConnected = false;
                    updateConnectionStatus('error');
                }
                throw error;
            }
        }

        // ãƒ†ã‚¹ãƒˆé–¢æ•°
        function testVoice() {
            if (!voiceEnabled) {
                alert('éŸ³å£°æ¡ˆå†…ã‚’ONã«ã—ã¦ãã ã•ã„');
                return;
            }
            console.log('ğŸ™ï¸ éŸ³å£°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
            if (audioCache['soundCheck']) {
                playAudioFile('soundCheck');
            } else {
                speakJapanese("éŸ³å£°æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ç›¸è«‡é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚");
            }
        }

        function testStartMessage() {
            if (!voiceEnabled) {
                alert('éŸ³å£°æ¡ˆå†…ã‚’ONã«ã—ã¦ãã ã•ã„');
                return;
            }
            console.log('â–¶ï¸ é–‹å§‹æ¡ˆå†…ãƒ†ã‚¹ãƒˆ');
            playAudioFile('start');
        }

        function showDebugInfo() {
            const loadedFiles = Object.keys(audioCache).filter(key => {
                const audio = audioCache[key];
                return audio && audio.readyState >= 3; // HAVE_FUTURE_DATAä»¥ä¸Š
            });
            
            const info = `
ğŸ™ï¸ éŸ³å£°çŠ¶æ…‹: ${voiceEnabled ? 'ON' : 'OFF'}
ğŸ”Š Speech API: ${voiceReady ? 'å¯¾å¿œ' : 'æœªå¯¾å¿œ'}
ğŸ”” é€šçŸ¥å±¥æ­´: ${Array.from(notifiedTimes).join(', ') || 'ãªã—'}
ğŸŒ æ¥ç¶šçŠ¶æ…‹: ${isConnected ? 'æ¥ç¶šæ¸ˆã¿' : 'æœªæ¥ç¶š'}
ğŸ“± ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent.includes('Mobile') ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}
ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: ${Object.keys(audioCache).length}å€‹ä¸­${loadedFiles.length}å€‹èª­ã¿è¾¼ã¿æ¸ˆã¿
ğŸ“ èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«: ${loadedFiles.join(', ') || 'ãªã—'}
            `;
            alert(info);
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
            console.log('ğŸ“Š è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
            Object.keys(audioCache).forEach(key => {
                const audio = audioCache[key];
                console.log(`  ${key}: readyState=${audio.readyState}, src=${audio.src}`);
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        soundToggle.addEventListener('click', toggleVoice);

        // éŸ³å£°ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
        speechSynthesis.onvoiceschanged = () => {
            initializeVoice();
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ“± ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            console.log('ğŸ¯ SessionTimeréŸ³å£°æ©Ÿèƒ½ä»˜ãç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ã‚’åˆæœŸåŒ–ã—ã¾ã™');
            
            // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®äº‹å‰èª­ã¿è¾¼ã¿
            preloadAudioFiles();
            
            // éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™
            initializeVoice();
            updateVoiceUI();
            console.log('ğŸ™ï¸ éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
            updateConnectionStatus('connecting');
            try {
                await fetchTimerState();
                console.log('âœ… åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
            } catch (error) {
                console.error('âŒ åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:', error);
            }
            
            // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            pollInterval = setInterval(fetchTimerState, 1000);
            console.log('ğŸ”„ 1ç§’é–“éš”ã§ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹');
            
            console.log('ğŸš€ ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>