<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer - Áõ∏Ë´áÂì°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #43C6AC 0%, #191654 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .connected { 
            background: rgba(76, 175, 80, 0.9);
            border-color: rgba(76, 175, 80, 0.5);
        }
        .connecting { 
            background: rgba(255, 152, 0, 0.9);
            border-color: rgba(255, 152, 0, 0.5);
        }
        .error { 
            background: rgba(244, 67, 54, 0.9);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .timer-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }

        .session-timer {
            font-size: 5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .session-label {
            font-size: 1.5rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .total-timer {
            font-size: 1.8rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .status-display {
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            display: inline-block;
        }

        /* Èü≥Â£∞ÈÄöÁü•„Éà„Ç∞„É´„Éú„Çø„É≥ */
        .sound-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 80px;
            height: 40px;
            background: #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active {
            background: #4CAF50;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(40px);
        }

        .sound-label {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .sound-status {
            font-size: 1.3rem;
            font-weight: bold;
            min-width: 80px;
        }

        .sound-status.enabled {
            color: #4CAF50;
        }

        .sound-status.disabled {
            color: #f44336;
        }

        /* Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */
        .voice-message {
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.5);
            border-radius: 15px;
            font-size: 1.1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.5s ease;
            max-width: 600px;
        }

        .voice-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* „ÉÜ„Çπ„Éà„Éú„Çø„É≥ */
        .test-controls {
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .test-btn {
            margin: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .sound-test-btn {
            background: #FF6B35;
            color: white;
        }

        .voice-test-btn {
            background: #9B59B6;
            color: white;
        }

        .debug-btn {
            background: #3498DB;
            color: white;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú */
        .timer-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            .session-timer {
                font-size: 3.5rem;
            }
            
            .session-label {
                font-size: 1.2rem;
            }
            
            .total-timer {
                font-size: 1.4rem;
            }
            
            .sound-toggle-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .toggle-switch {
                width: 70px;
                height: 35px;
            }
            
            .toggle-slider {
                width: 27px;
                height: 27px;
                top: 4px;
                left: 4px;
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(35px);
            }
        }

        @media (max-width: 480px) {
            .session-timer {
                font-size: 2.8rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Êé•Á∂ö‰∏≠...</div>
    
    <div class="header">
        <h1>üéØ SessionTimer - Áõ∏Ë´áÂì°</h1>
    </div>

    <div class="timer-display">
        <div class="session-timer" id="sessionTimer">20:00</div>
        <div class="session-label">ÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥</div>
        <div class="total-timer">ÂÖ®‰ΩìÊÆã„ÇäÊôÇÈñì: <span id="totalTimer">02:00:00</span></div>
        
        <div class="status-display">
            <span id="statusText">„Çπ„ÉÜ„Éº„Çø„Çπ: ‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠</span>
        </div>

        <!-- Èü≥Â£∞ÈÄöÁü•„Éà„Ç∞„É´„Éú„Çø„É≥ -->
        <div class="sound-toggle-container">
            <span class="sound-label">üéôÔ∏è Èü≥Â£∞Ê°àÂÜÖ</span>
            <div class="toggle-switch" id="soundToggle">
                <div class="toggle-slider"></div>
            </div>
            <span class="sound-status disabled" id="soundStatus">OFF</span>
        </div>

        <!-- Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
        <div class="voice-message" id="voiceMessage"></div>
    </div>

    <div class="test-controls">
        <button class="test-btn voice-test-btn" onclick="testVoice()">üéôÔ∏è Èü≥Â£∞„ÉÜ„Çπ„Éà</button>
        <button class="test-btn debug-btn" onclick="showDebugInfo()">üìä „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</button>
        <button class="test-btn sound-test-btn" onclick="testStartMessage()">‚ñ∂Ô∏è ÈñãÂßãÊ°àÂÜÖ„ÉÜ„Çπ„Éà</button>
    </div>

    <script>
        console.log('üöÄ SessionTimer Áõ∏Ë´áÂì°„Éö„Éº„Ç∏„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü');
        
        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const totalTimerElement = document.getElementById('totalTimer');
        const sessionTimerElement = document.getElementById('sessionTimer');
        const statusElement = document.getElementById('statusText');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const soundToggle = document.getElementById('soundToggle');
        const soundStatus = document.getElementById('soundStatus');
        const voiceMessageElement = document.getElementById('voiceMessage');
        
        let isConnected = false;
        let pollInterval = null;
        let voiceEnabled = false;
        let previousSessionTime = null;
        let previousStatus = null;
        let notifiedTimes = new Set();

        // Web Speech API
        let speechSynthesis = window.speechSynthesis;
        let voiceReady = false;

        // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ
        const audioFiles = {
            start: '/sounds/counselor_start.wav',
            min10: '/sounds/counselor_10min.wav',
            min15: '/sounds/counselor_15min.wav',
            min17: '/sounds/counselor_17min.wav',
            min18: '/sounds/counselor_18min.wav',
            min19: '/sounds/counselor_19min.wav',
            min20: '/sounds/counselor_end.wav'
        };

        // Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Éá„Éº„Çø
        const voiceMessages = {
            start: "„Åæ„ÇÇ„Å™„ÅèÁõ∏Ë´áËÄÖ„Åï„Çì„Åå„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åô„ÄÇÁùÄÂ∏≠„Åó„Å¶ÂæÖÊ©ü„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ",
            min10: "10ÂàÜ„ÅåÁµåÈÅé„Åó„Åæ„Åó„Åü„ÄÇÁõ∏Ë´á„ÅÆÈÄ≤Ë°åÁä∂Ê≥Å„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ",
            min15: "15ÂàÜ„ÅåÁµåÈÅé„Åó„Åæ„Åó„Åü„ÄÇÊÆã„ÇäÊôÇÈñì„ÅØ5ÂàÜ„Åß„Åô„ÄÇ",
            min17: "ÊÆã„ÇäÊôÇÈñì„ÅØ3ÂàÜ„Åß„Åô„ÄÇ„Åæ„Å®„ÇÅ„ÅÆÊ∫ñÂÇô„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ",
            min18: "ÊÆã„ÇäÊôÇÈñì„ÅØ2ÂàÜ„Åß„Åô„ÄÇ",
            min19: "ÊÆã„ÇäÊôÇÈñì„ÅØ1ÂàÜ„Åß„Åô„ÄÇ",
            min20: "„ÅäÁñ≤„ÇåÊßò„Åß„Åó„Åü„ÄÇÊúÄÂæå„Å´Âøò„ÇåÁâ©„Åå„Å™„ÅÑ„Åã„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰∏çÊòé„Å™ÁÇπ„Åå„ÅÇ„Çå„Å∞Âèó‰ªò„Å´„Å¶Êâø„Çä„Åæ„Åô„ÄÇ"
        };

        // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ‰∫ãÂâçË™≠„ÅøËæº„Åø
        const audioCache = {};
        
        function preloadAudioFiles() {
            Object.keys(audioFiles).forEach(key => {
                const audio = new Audio();
                audio.preload = 'auto';
                audio.src = audioFiles[key];
                audio.volume = 0.8;
                
                audio.addEventListener('canplaythrough', () => {
                    console.log(`‚úÖ Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${key}`);
                });
                
                audio.addEventListener('error', (e) => {
                    console.error(`‚ùå Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ${key}`, e);
                });
                
                audioCache[key] = audio;
            });
        }

        // WAV„Éï„Ç°„Ç§„É´„Å´„Çà„ÇãÈü≥Â£∞ÂÜçÁîü
        function playAudioFile(key, callback = null) {
            if (!voiceEnabled) {
                console.log('üîá Èü≥Â£∞ÁÑ°Âäπ');
                return;
            }

            const audio = audioCache[key];
            if (!audio) {
                console.error(`‚ùå Èü≥Â£∞„Éï„Ç°„Ç§„É´Êú™ÁôªÈå≤: ${key}`);
                return;
            }

            try {
                // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîªÈù¢„Å´Ë°®Á§∫
                showVoiceMessage(voiceMessages[key]);

                // Èü≥Â£∞ÂÜçÁîü
                audio.currentTime = 0; // ÊúÄÂàù„Åã„ÇâÂÜçÁîü
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log(`üéµ Èü≥Â£∞ÂÜçÁîüÈñãÂßã: ${key}`);
                    }).catch((error) => {
                        console.error(`‚ùå Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº: ${key}`, error);
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Web Speech API
                        speakJapanese(voiceMessages[key], callback);
                    });
                }

                audio.onended = () => {
                    console.log(`‚úÖ Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü: ${key}`);
                    if (callback) callback();
                };

            } catch (error) {
                console.error(`‚ùå Èü≥Â£∞ÂÜçÁîüÂ§±Êïó: ${key}`, error);
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Web Speech API
                speakJapanese(voiceMessages[key], callback);
            }
        }

        // Èü≥Â£∞ÂêàÊàê„ÅÆÂàùÊúüÂåñ
        function initializeVoice() {
            try {
                if ('speechSynthesis' in window) {
                    // Êó•Êú¨Ë™ûÈü≥Â£∞„ÅÆÊ∫ñÂÇô
                    const voices = speechSynthesis.getVoices();
                    console.log('üéôÔ∏è Âà©Áî®ÂèØËÉΩ„Å™Èü≥Â£∞:', voices.length);
                    voiceReady = true;
                    return true;
                } else {
                    console.error('‚ùå Web Speech API not supported');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Èü≥Â£∞ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                return false;
            }
        }

        // Êó•Êú¨Ë™ûÈü≥Â£∞„ÅÆÂÜçÁîü
        function speakJapanese(text, callback = null) {
            if (!voiceEnabled || !voiceReady) {
                console.log('üîá Èü≥Â£∞ÁÑ°Âäπ„Åæ„Åü„ÅØÊú™ÂØæÂøú');
                return;
            }

            try {
                // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîªÈù¢„Å´Ë°®Á§∫
                showVoiceMessage(text);

                // Èü≥Â£∞ÂêàÊàê
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9; // Â∞ë„Åó„ÇÜ„Å£„Åè„Çä
                utterance.pitch = 1.0;
                utterance.volume = 0.8;

                // Êó•Êú¨Ë™ûÈü≥Â£∞„ÇíÈÅ∏Êäû
                const voices = speechSynthesis.getVoices();
                const japaneseVoice = voices.find(voice => voice.lang.includes('ja'));
                if (japaneseVoice) {
                    utterance.voice = japaneseVoice;
                }

                utterance.onstart = () => {
                    console.log('üéôÔ∏è Èü≥Â£∞ÂÜçÁîüÈñãÂßã:', text);
                };

                utterance.onend = () => {
                    console.log('‚úÖ Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü');
                    if (callback) callback();
                };

                utterance.onerror = (event) => {
                    console.error('‚ùå Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', event.error);
                };

                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error('‚ùå Èü≥Â£∞ÂÜçÁîüÂ§±Êïó:', error);
            }
        }

        // Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÁîªÈù¢Ë°®Á§∫
        function showVoiceMessage(text) {
            voiceMessageElement.textContent = text;
            voiceMessageElement.classList.add('show');
            
            // 5ÁßíÂæå„Å´ÈùûË°®Á§∫
            setTimeout(() => {
                voiceMessageElement.classList.remove('show');
            }, 5000);
        }

        // Èü≥Â£∞ÈÄöÁü•„ÅÆÂàá„ÇäÊõø„Åà
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            updateVoiceUI();
            
            if (voiceEnabled) {
                // ÊúâÂäπ„Å´„Åó„ÅüÊôÇ„ÅÆ„ÉÜ„Çπ„ÉàÈü≥Â£∞
                if (audioCache['start']) {
                    playAudioFile('start');
                } else {
                    speakJapanese("Èü≥Â£∞Ê°àÂÜÖ„ÇíÈñãÂßã„Åó„Åæ„Åô„ÄÇ");
                }
            }
        }

        // Èü≥Â£∞UI„ÅÆÊõ¥Êñ∞
        function updateVoiceUI() {
            if (voiceEnabled) {
                soundToggle.classList.add('active');
                soundStatus.textContent = 'ON';
                soundStatus.className = 'sound-status enabled';
            } else {
                soundToggle.classList.remove('active');
                soundStatus.textContent = 'OFF';
                soundStatus.className = 'sound-status disabled';
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì„Å´Âü∫„Å•„ÅèÈü≥Â£∞Ê°àÂÜÖ
        function checkSessionNotifications(currentSessionTime, isPaused) {
            if (!voiceEnabled) return;

            const elapsedTime = 1200 - currentSessionTime; // ÁµåÈÅéÊôÇÈñìÔºàÁßíÔºâ
            
            // ÈÄöÁü•„Çø„Ç§„Éü„É≥„Ç∞ÔºàÁµåÈÅéÊôÇÈñì„Éô„Éº„ÇπÔºâ
            const notifications = [
                { time: 600, key: 'min10' },   // 10ÂàÜÁµåÈÅé
                { time: 900, key: 'min15' },   // 15ÂàÜÁµåÈÅé
                { time: 1020, key: 'min17' },  // 17ÂàÜÁµåÈÅé
                { time: 1080, key: 'min18' },  // 18ÂàÜÁµåÈÅé
                { time: 1140, key: 'min19' },  // 19ÂàÜÁµåÈÅé
                { time: 1200, key: 'min20' }   // 20ÂàÜÁµåÈÅé
            ];

            notifications.forEach(notification => {
                if (elapsedTime >= notification.time && !notifiedTimes.has(notification.time) && !isPaused) {
                    console.log(`üîî Èü≥Â£∞Ê°àÂÜÖ: ${notification.key}`);
                    playAudioFile(notification.key);
                    notifiedTimes.add(notification.time);
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
                    sessionTimerElement.classList.add('timer-pulse');
                    setTimeout(() => {
                        sessionTimerElement.classList.remove('timer-pulse');
                    }, 2000);
                }
            });
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÅÆÊ§úÂá∫
        function checkSessionStart(currentStatus, previousStatus) {
            if (voiceEnabled && previousStatus === '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠' && currentStatus === 'ÂÆüË°å‰∏≠') {
                console.log('üîî „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊ§úÂá∫');
                playAudioFile('start');
                notifiedTimes.clear(); // ÈÄöÁü•Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
            }
        }

        // ÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        // „Çø„Ç§„Éû„ÉºÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateTimerDisplay(data) {
            const currentStatus = data.isPaused ? '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠' : 'ÂÆüË°å‰∏≠';
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÅÆÊ§úÂá∫
            checkSessionStart(currentStatus, previousStatus);
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñìÈÄöÁü•„ÅÆÁ¢∫Ë™ç
            if (data.sessionTime !== previousSessionTime) {
                checkSessionNotifications(data.sessionTime, data.isPaused);
                previousSessionTime = data.sessionTime;
            }
            
            sessionTimerElement.textContent = formatTime(data.sessionTime);
            totalTimerElement.textContent = formatTime(data.totalTime);
            statusElement.textContent = `„Çπ„ÉÜ„Éº„Çø„Çπ: ${currentStatus}`;
            
            previousStatus = currentStatus;
        }

        // Êé•Á∂öÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateConnectionStatus(status) {
            connectionStatusElement.className = `connection-status ${status}`;
            connectionStatusElement.textContent = 
                status === 'connected' ? 'Êé•Á∂öÊ∏à„Åø' :
                status === 'connecting' ? 'Êé•Á∂ö‰∏≠...' : 'Êé•Á∂ö„Ç®„É©„Éº';
        }

        // APIÂëº„Å≥Âá∫„Åó
        async function fetchTimerState() {
            try {
                const response = await fetch('/api/timer');
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                updateTimerDisplay(data);
                
                if (!isConnected) {
                    isConnected = true;
                    updateConnectionStatus('connected');
                    console.log('üåê „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü');
                }
                
                return data;
            } catch (error) {
                console.error('‚ùå APIÂèñÂæó„Ç®„É©„Éº:', error);
                if (isConnected) {
                    isConnected = false;
                    updateConnectionStatus('error');
                }
                throw error;
            }
        }

        // „ÉÜ„Çπ„ÉàÈñ¢Êï∞
        function testVoice() {
            if (!voiceEnabled) {
                alert('Èü≥Â£∞Ê°àÂÜÖ„ÇíON„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            console.log('üéôÔ∏è Èü≥Â£∞„ÉÜ„Çπ„ÉàÂÆüË°å');
            if (audioCache['min10']) {
                playAudioFile('min10');
            } else {
                speakJapanese("Èü≥Â£∞Ê°àÂÜÖ„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô„ÄÇÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ");
            }
        }

        function testStartMessage() {
            if (!voiceEnabled) {
                alert('Èü≥Â£∞Ê°àÂÜÖ„ÇíON„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            console.log('‚ñ∂Ô∏è ÈñãÂßãÊ°àÂÜÖ„ÉÜ„Çπ„Éà');
            playAudioFile('start');
        }

        function showDebugInfo() {
            const info = `
üéôÔ∏è Èü≥Â£∞Áä∂ÊÖã: ${voiceEnabled ? 'ON' : 'OFF'}
üîä Speech API: ${voiceReady ? 'ÂØæÂøú' : 'Êú™ÂØæÂøú'}
üîî ÈÄöÁü•Â±•Ê≠¥: ${Array.from(notifiedTimes).join(', ')}
üåê Êé•Á∂öÁä∂ÊÖã: ${isConnected ? 'Êé•Á∂öÊ∏à„Åø' : 'Êú™Êé•Á∂ö'}
üì± „É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà: ${navigator.userAgent.includes('Mobile') ? '„É¢„Éê„Ç§„É´' : '„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó'}
üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´: ${Object.keys(audioCache).length}/7 Ë™≠„ÅøËæº„ÅøÊ∏à„Åø
            `;
            alert(info);
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        soundToggle.addEventListener('click', toggleVoice);

        // Èü≥Â£∞„É™„Çπ„Éà„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
        speechSynthesis.onvoiceschanged = () => {
            initializeVoice();
        };

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂæå„ÅÆÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üì± Áõ∏Ë´áÂì°„Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
            
            // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ‰∫ãÂâçË™≠„ÅøËæº„Åø
            preloadAudioFiles();
            
            // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÊ∫ñÂÇô
            initializeVoice();
            updateVoiceUI();
            
            // ÂàùÊúü„Éá„Éº„ÇøÂèñÂæó
            updateConnectionStatus('connecting');
            try {
                await fetchTimerState();
            } catch (error) {
                console.error('ÂàùÊúü„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó:', error);
            }
            
            // „Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
            pollInterval = setInterval(fetchTimerState, 1000);
            console.log('üîÑ „Éù„Éº„É™„É≥„Ç∞ÈñãÂßã');
        });

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>