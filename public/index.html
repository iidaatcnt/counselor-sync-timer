<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer - Áõ∏Ë´áÂì°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #43C6AC 0%, #191654 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .connected { 
            background: rgba(76, 175, 80, 0.9);
            border-color: rgba(76, 175, 80, 0.5);
        }
        .connecting { 
            background: rgba(255, 152, 0, 0.9);
            border-color: rgba(255, 152, 0, 0.5);
        }
        .error { 
            background: rgba(244, 67, 54, 0.9);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .timer-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }

        .session-timer {
            font-size: 5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .session-label {
            font-size: 1.5rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .total-timer {
            font-size: 1.8rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .status-display {
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            display: inline-block;
        }

        /* Èü≥Â£∞ÈÄöÁü•„Éà„Ç∞„É´„Éú„Çø„É≥ */
        .sound-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 80px;
            height: 40px;
            background: #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active {
            background: #4CAF50;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(40px);
        }

        .sound-label {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .sound-status {
            font-size: 1.3rem;
            font-weight: bold;
            min-width: 80px;
        }

        .sound-status.enabled {
            color: #4CAF50;
        }

        .sound-status.disabled {
            color: #f44336;
        }

        /* Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */
        .voice-message {
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.5);
            border-radius: 15px;
            font-size: 1.1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.5s ease;
            max-width: 600px;
        }

        .voice-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* „ÉÜ„Çπ„Éà„Éú„Çø„É≥ */
        .test-controls {
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .test-btn {
            margin: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .sound-test-btn {
            background: #FF6B35;
            color: white;
        }

        .voice-test-btn {
            background: #9B59B6;
            color: white;
        }

        .debug-btn {
            background: #3498DB;
            color: white;
        }

        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú */
        .timer-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
        @media (max-width: 768px) {
            .session-timer {
                font-size: 3.5rem;
            }
            
            .session-label {
                font-size: 1.2rem;
            }
            
            .total-timer {
                font-size: 1.4rem;
            }
            
            .sound-toggle-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .toggle-switch {
                width: 70px;
                height: 35px;
            }
            
            .toggle-slider {
                width: 27px;
                height: 27px;
                top: 4px;
                left: 4px;
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(35px);
            }
        }

        @media (max-width: 480px) {
            .session-timer {
                font-size: 2.8rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">Êé•Á∂ö‰∏≠...</div>
    
    <div class="header">
        <h1>üéØ SessionTimer - Áõ∏Ë´áÂì°</h1>
    </div>

    <div class="timer-display">
        <div class="session-timer" id="sessionTimer">20:00</div>
        <div class="session-label">ÁèæÂú®„ÅÆ„Çª„ÉÉ„Ç∑„Éß„É≥</div>
        <div class="total-timer">ÂÖ®‰ΩìÊÆã„ÇäÊôÇÈñì: <span id="totalTimer">02:00:00</span></div>
        
        <div class="status-display">
            <span id="statusText">„Çπ„ÉÜ„Éº„Çø„Çπ: ‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠</span>
        </div>

        <!-- Èü≥Â£∞ÈÄöÁü•„Éà„Ç∞„É´„Éú„Çø„É≥ -->
        <div class="sound-toggle-container">
            <span class="sound-label">üéôÔ∏è Èü≥Â£∞Ê°àÂÜÖ</span>
            <div class="toggle-switch" id="soundToggle">
                <div class="toggle-slider"></div>
            </div>
            <span class="sound-status disabled" id="soundStatus">OFF</span>
        </div>

        <!-- Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ -->
        <div class="voice-message" id="voiceMessage"></div>
    </div>

    <div class="test-controls">
        <button class="test-btn voice-test-btn" onclick="testVoice()">üéôÔ∏è Èü≥Â£∞„ÉÜ„Çπ„Éà</button>
        <button class="test-btn debug-btn" onclick="showDebugInfo()">üìä „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±</button>
    </div>

    <script>
        console.log('üöÄ SessionTimer Áõ∏Ë´áÂì°„Éö„Éº„Ç∏ÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâ„ÅåÈñãÂßã„Åï„Çå„Åæ„Åó„Åü');
        
        // „Éö„Éº„Ç∏„ÅÆ‰∏ÄÊÑèË≠òÂà•Â≠ê„ÇíÁîüÊàêÔºàË§áÊï∞„Çø„ÉñË≠òÂà•Áî®Ôºâ
        const pageId = 'counselor-' + Math.random().toString(36).substr(2, 9);
        const startTime = Date.now();
        console.log(`üÜî „Éö„Éº„Ç∏ID: ${pageId}`);
        console.log(`üïê Ëµ∑ÂãïÊôÇÂàª: ${new Date().toLocaleString()}`);
        
        // Ë§áÊï∞„Çø„ÉñÂØæÂøú„ÅÆ„Åü„ÇÅ„ÅÆÂ§âÊï∞
        let isTabActive = true;
        let lastActivityTime = Date.now();
        let audioPlaybackLock = false;
        
        // DOMË¶ÅÁ¥†„ÅÆÂèñÂæó
        const totalTimerElement = document.getElementById('totalTimer');
        const sessionTimerElement = document.getElementById('sessionTimer');
        const statusElement = document.getElementById('statusText');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const soundToggle = document.getElementById('soundToggle');
        const soundStatus = document.getElementById('soundStatus');
        const voiceMessageElement = document.getElementById('voiceMessage');
        
        // Ë§áÊï∞„Çø„ÉñÂØæÂøúÔºö„Çø„Éñ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        function initTabCoordination() {
            // „Çø„Éñ„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÁõ£Ë¶ñ
            document.addEventListener('visibilitychange', () => {
                isTabActive = !document.hidden;
                const timestamp = new Date().toLocaleTimeString();
                
                if (isTabActive) {
                    console.log(`üëÅÔ∏è [${timestamp}] [${pageId}] „Çø„Éñ„Åå„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Å™„Çä„Åæ„Åó„Åü`);
                    lastActivityTime = Date.now();
                } else {
                    console.log(`üò¥ [${timestamp}] [${pageId}] „Çø„Éñ„ÅåÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Å™„Çä„Åæ„Åó„Åü`);
                }
            });
            
            // „Ç¶„Ç£„É≥„Éâ„Ç¶„Éï„Ç©„Éº„Ç´„ÇπÁõ£Ë¶ñ
            window.addEventListener('focus', () => {
                isTabActive = true;
                lastActivityTime = Date.now();
                console.log(`üéØ [${pageId}] „Ç¶„Ç£„É≥„Éâ„Ç¶„Éï„Ç©„Éº„Ç´„ÇπÂèñÂæó`);
            });
            
            window.addEventListener('blur', () => {
                console.log(`üòê [${pageId}] „Ç¶„Ç£„É≥„Éâ„Ç¶„Éï„Ç©„Éº„Ç´„ÇπÂñ™Â§±`);
            });
        }
        
        // Ë§áÊï∞„Çø„ÉñÂØæÂøúÔºöÈü≥Â£∞ÂÜçÁîüÊ®©„ÅÆÁÆ°ÁêÜ
        function requestAudioPlayback(audioType) {
            const key = 'sessiontimer_audio_lock';
            const now = Date.now();
            
            try {
                // Êó¢Â≠ò„ÅÆ„É≠„ÉÉ„ÇØÁä∂Ê≥ÅÁ¢∫Ë™ç
                const existingLock = localStorage.getItem(key);
                if (existingLock) {
                    const lockData = JSON.parse(existingLock);
                    
                    // 5Áßí‰ª•ÂÜÖ„ÅÆ‰ªñ„ÅÆ„Çø„Éñ„ÅÆ„É≠„ÉÉ„ÇØ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂÜçÁîü„Åó„Å™„ÅÑ
                    if (lockData.timestamp > now - 5000 && lockData.pageId !== pageId) {
                        console.log(`üîí [${pageId}] ‰ªñ„ÅÆ„Çø„ÉñÔºà${lockData.pageId}Ôºâ„ÅåÈü≥Â£∞ÂÜçÁîü‰∏≠„ÅÆ„Åü„ÇÅ„ÄÅÂÜçÁîü„Çí„Çπ„Ç≠„ÉÉ„Éó`);
                        return false;
                    }
                }
                
                // Èü≥Â£∞ÂÜçÁîüÊ®©„ÇíÂèñÂæó
                const lockData = {
                    pageId: pageId,
                    timestamp: now,
                    audioType: audioType,
                    isActive: isTabActive
                };
                
                localStorage.setItem(key, JSON.stringify(lockData));
                console.log(`üîì [${pageId}] Èü≥Â£∞ÂÜçÁîüÊ®©„ÇíÂèñÂæó: ${audioType}`);
                
                // 3ÁßíÂæå„Å´„É≠„ÉÉ„ÇØ„ÇíËß£Èô§
                setTimeout(() => {
                    try {
                        const currentLock = localStorage.getItem(key);
                        if (currentLock) {
                            const currentData = JSON.parse(currentLock);
                            if (currentData.pageId === pageId && currentData.timestamp === now) {
                                localStorage.removeItem(key);
                                console.log(`üîì [${pageId}] Èü≥Â£∞ÂÜçÁîü„É≠„ÉÉ„ÇØ„ÇíËß£Èô§`);
                            }
                        }
                    } catch (e) {
                        console.warn(`‚ö†Ô∏è [${pageId}] „É≠„ÉÉ„ÇØËß£Èô§„Ç®„É©„Éº:`, e);
                    }
                }, 3000);
                
                return true;
                
            } catch (error) {
                console.warn(`‚ö†Ô∏è [${pageId}] localStorage‰ΩøÁî®‰∏çÂèØ„ÄÅÈü≥Â£∞ÂÜçÁîü„ÇíÁ∂ôÁ∂ö:`, error);
                return true; // localStorage „Åå‰Ωø„Åà„Å™„ÅÑÂ†¥Âêà„ÅØÂÜçÁîü„ÇíË®±ÂèØ
            }
        }
        
        // Ë§áÊï∞„Çø„ÉñÂØæÂøúÔºöÈáçË§á„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊ§úÂá∫„ÅÆÈò≤Ê≠¢
        function checkTabSpecificSessionStart(currentStatus, previousStatus) {
            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ„Åß„ÅÆ„Åø„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÇíÊ§úÂá∫
            if (!isTabActive && voiceEnabled) {
                console.log(`üò¥ [${pageId}] Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„ÅÆ„Åü„ÇÅ„ÄÅ„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊ§úÂá∫„Çí„Çπ„Ç≠„ÉÉ„Éó`);
                return false;
            }
            
            // ÊúÄËøë„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£„Åå„ÅÇ„Çã„Çø„Éñ„ÅÆ„Åø„ÅßÂá¶ÁêÜ
            const timeSinceActivity = Date.now() - lastActivityTime;
            if (timeSinceActivity > 10000) { // 10Áßí‰ª•‰∏äÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
                console.log(`‚è∞ [${pageId}] Èï∑ÊôÇÈñìÈùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÔºà${Math.floor(timeSinceActivity/1000)}ÁßíÔºâ„ÅÆ„Åü„ÇÅ„ÄÅ„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊ§úÂá∫„Çí„Çπ„Ç≠„ÉÉ„Éó`);
                return false;
            }
            
            return true;
        }
        let isConnected = false;
        let voiceEnabled = false;
        let previousSessionTime = null;
        let previousStatus = null;
        let notifiedTimes = new Set();

        // Web Speech API
        let speechSynthesis = window.speechSynthesis;
        let voiceReady = false;

        // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ„Éë„Çπ
        const audioFiles = {
            start: '/sounds/counselor_start.wav',
            min10: '/sounds/counselor_10min.wav',
            min15: '/sounds/counselor_15min.wav',
            min17: '/sounds/counselor_17min.wav',
            min18: '/sounds/counselor_18min.wav',
            min19: '/sounds/counselor_19min.wav',
            min20: '/sounds/counselor_end.wav',
            soundCheck: '/sounds/counselor_sound_check.wav'
        };

        // Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Éá„Éº„Çø
        const voiceMessages = {
            start: "„Åæ„ÇÇ„Å™„ÅèÁõ∏Ë´áËÄÖ„Åï„Çì„Åå„ÅÑ„Çâ„Å£„Åó„ÇÉ„ÅÑ„Åæ„Åô„ÄÇÁùÄÂ∏≠„Åó„Å¶ÂæÖÊ©ü„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ",
            min10: "10ÂàÜ„ÅåÁµåÈÅé„Åó„Åæ„Åó„Åü„ÄÇÁõ∏Ë´á„ÅÆÈÄ≤Ë°åÁä∂Ê≥Å„Çí„ÅîÁ¢∫Ë™ç„Åè„Å†„Åï„ÅÑ„ÄÇ",
            min15: "15ÂàÜ„ÅåÁµåÈÅé„Åó„Åæ„Åó„Åü„ÄÇÊÆã„ÇäÊôÇÈñì„ÅØ5ÂàÜ„Åß„Åô„ÄÇ",
            min17: "ÊÆã„ÇäÊôÇÈñì„ÅØ3ÂàÜ„Åß„Åô„ÄÇ„Åæ„Å®„ÇÅ„ÅÆÊ∫ñÂÇô„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô„ÄÇ",
            min18: "ÊÆã„ÇäÊôÇÈñì„ÅØ2ÂàÜ„Åß„Åô„ÄÇ",
            min19: "ÊÆã„ÇäÊôÇÈñì„ÅØ1ÂàÜ„Åß„Åô„ÄÇ",
            min20: "„ÅäÁñ≤„ÇåÊßò„Åß„Åó„Åü„ÄÇÊúÄÂæå„Å´Âøò„ÇåÁâ©„Åå„Å™„ÅÑ„Åã„ÇÇ„ÅÜ‰∏ÄÂ∫¶Á¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ‰∏çÊòé„Å™ÁÇπ„Åå„ÅÇ„Çå„Å∞Âèó‰ªò„Å´„Å¶Êâø„Çä„Åæ„Åô„ÄÇ",
            soundCheck: "Èü≥Â£∞Ê°àÂÜÖ„Ç∑„Çπ„ÉÜ„É†„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô„ÄÇÁõ∏Ë´áÈñãÂßã„Åã„ÇâÁµÇ‰∫Ü„Åæ„Åß„ÄÅÈÅ©Âàá„Å™„Çø„Ç§„Éü„É≥„Ç∞„Åß„ÅîÊ°àÂÜÖ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ"
        };

        // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ‰∫ãÂâçË™≠„ÅøËæº„Åø
        const audioCache = {};
        
        function preloadAudioFiles() {
            console.log('üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ‰∫ãÂâçË™≠„ÅøËæº„Åø„ÇíÈñãÂßã');
            
            Object.keys(audioFiles).forEach(key => {
                const audio = new Audio();
                audio.preload = 'auto';
                audio.src = audioFiles[key];
                audio.volume = 0.8;
                
                audio.addEventListener('canplaythrough', () => {
                    console.log(`‚úÖ Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü: ${key} (${audioFiles[key]})`);
                });
                
                audio.addEventListener('error', (e) => {
                    console.error(`‚ùå Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÂ§±Êïó: ${key} (${audioFiles[key]})`, e);
                });
                
                // Ë™≠„ÅøËæº„ÅøÁä∂Ê≥Å„ÇíÂÆöÊúü„ÉÅ„Çß„ÉÉ„ÇØ
                audio.addEventListener('loadstart', () => {
                    console.log(`üîÑ Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„ÅøÈñãÂßã: ${key}`);
                });
                
                audioCache[key] = audio;
            });
            
            console.log(`üéµ ${Object.keys(audioFiles).length}ÂÄã„ÅÆÈü≥Â£∞„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü`);
        }

        // WAV„Éï„Ç°„Ç§„É´„Å´„Çà„ÇãÈü≥Â£∞ÂÜçÁîüÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâ
        function playAudioFile(key, callback = null) {
            if (!voiceEnabled) {
                console.log(`üîá [${pageId}] Èü≥Â£∞ÁÑ°Âäπ„ÅÆ„Åü„ÇÅÂÜçÁîü„Çí„Çπ„Ç≠„ÉÉ„Éó`);
                return;
            }

            // Ë§áÊï∞„Çø„Éñ„Åß„ÅÆÈü≥Â£∞ÂÜçÁîüÊ®©„ÉÅ„Çß„ÉÉ„ÇØ
            if (!requestAudioPlayback(key)) {
                console.log(`üîí [${pageId}] Èü≥Â£∞ÂÜçÁîüÊ®©„ÇíÂèñÂæó„Åß„Åç„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂÜçÁîü„Çí„Çπ„Ç≠„ÉÉ„Éó: ${key}`);
                return;
            }

            const audio = audioCache[key];
            if (!audio) {
                console.error(`‚ùå [${pageId}] Èü≥Â£∞„Éï„Ç°„Ç§„É´Êú™ÁôªÈå≤: ${key}`);
                console.log(`üîÑ [${pageId}] Web Speech API„Åß‰ª£ÊõøÂÜçÁîü`);
                speakJapanese(voiceMessages[key], callback);
                return;
            }

            try {
                // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîªÈù¢„Å´Ë°®Á§∫
                showVoiceMessage(voiceMessages[key]);

                // Èü≥Â£∞ÂÜçÁîü„ÅÆÊ∫ñÂÇô
                audio.currentTime = 0; // ÊúÄÂàù„Åã„ÇâÂÜçÁîü
                
                // Èü≥ÈáèÁ¢∫Ë™ç
                if (audio.volume < 0.5) {
                    audio.volume = 0.8;
                    console.log(`üîä [${pageId}] Èü≥Èáè„Çí0.8„Å´Ë™øÊï¥`);
                }
                
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log(`üéµ [${pageId}] Èü≥Â£∞„Éï„Ç°„Ç§„É´ÂÜçÁîüÈñãÂßã: ${key} (${audioFiles[key]})`);
                    }).catch((error) => {
                        console.error(`‚ùå [${pageId}] Èü≥Â£∞„Éï„Ç°„Ç§„É´ÂÜçÁîü„Ç®„É©„Éº: ${key}`, error);
                        console.log(`üîÑ [${pageId}] Web Speech API„Åß‰ª£ÊõøÂÜçÁîü`);
                        speakJapanese(voiceMessages[key], callback);
                    });
                }

                audio.onended = () => {
                    console.log(`‚úÖ [${pageId}] Èü≥Â£∞„Éï„Ç°„Ç§„É´ÂÜçÁîüÂÆå‰∫Ü: ${key}`);
                    if (callback) callback();
                };

            } catch (error) {
                console.error(`‚ùå [${pageId}] Èü≥Â£∞„Éï„Ç°„Ç§„É´ÂÜçÁîüÂ§±Êïó: ${key}`, error);
                console.log(`üîÑ [${pageId}] Web Speech API„Åß‰ª£ÊõøÂÜçÁîü`);
                speakJapanese(voiceMessages[key], callback);
            }
        }

        // Èü≥Â£∞ÂêàÊàê„ÅÆÂàùÊúüÂåñ
        function initializeVoice() {
            try {
                if ('speechSynthesis' in window) {
                    // Êó•Êú¨Ë™ûÈü≥Â£∞„ÅÆÊ∫ñÂÇô
                    const voices = speechSynthesis.getVoices();
                    console.log('üéôÔ∏è Âà©Áî®ÂèØËÉΩ„Å™Èü≥Â£∞:', voices.length);
                    voiceReady = true;
                    return true;
                } else {
                    console.error('‚ùå Web Speech API not supported');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Èü≥Â£∞ÂàùÊúüÂåñ„Ç®„É©„Éº:', error);
                return false;
            }
        }

        // Êó•Êú¨Ë™ûÈü≥Â£∞„ÅÆÂÜçÁîüÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâ
        function speakJapanese(text, callback = null) {
            if (!voiceEnabled || !voiceReady) {
                console.log(`üîá [${pageId}] Èü≥Â£∞ÁÑ°Âäπ„Åæ„Åü„ÅØÊú™ÂØæÂøú`);
                return;
            }

            try {
                // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíÁîªÈù¢„Å´Ë°®Á§∫
                showVoiceMessage(text);

                // Èü≥Â£∞ÂêàÊàê
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9; // Â∞ë„Åó„ÇÜ„Å£„Åè„Çä
                utterance.pitch = 1.0;
                utterance.volume = 0.8;

                // Êó•Êú¨Ë™ûÈü≥Â£∞„ÇíÈÅ∏Êäû
                const voices = speechSynthesis.getVoices();
                const japaneseVoice = voices.find(voice => voice.lang.includes('ja'));
                if (japaneseVoice) {
                    utterance.voice = japaneseVoice;
                }

                utterance.onstart = () => {
                    console.log(`üéôÔ∏è [${pageId}] Web Speech API Èü≥Â£∞ÂÜçÁîüÈñãÂßã:`, text);
                };

                utterance.onend = () => {
                    console.log(`‚úÖ [${pageId}] Web Speech API Èü≥Â£∞ÂÜçÁîüÂÆå‰∫Ü`);
                    if (callback) callback();
                };

                utterance.onerror = (event) => {
                    console.error(`‚ùå [${pageId}] Web Speech API Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:`, event.error);
                };

                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error(`‚ùå [${pageId}] Web Speech API Èü≥Â£∞ÂÜçÁîüÂ§±Êïó:`, error);
            }
        }

        // Èü≥Â£∞„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÁîªÈù¢Ë°®Á§∫
        function showVoiceMessage(text) {
            voiceMessageElement.textContent = text;
            voiceMessageElement.classList.add('show');
            
            // 5ÁßíÂæå„Å´ÈùûË°®Á§∫
            setTimeout(() => {
                voiceMessageElement.classList.remove('show');
            }, 5000);
        }

        // Èü≥Â£∞ÈÄöÁü•„ÅÆÂàá„ÇäÊõø„Åà
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            updateVoiceUI();
            
            if (voiceEnabled) {
                console.log(`üéôÔ∏è [${pageId}] Èü≥Â£∞Ê°àÂÜÖ„ÇíON„Å´„Åó„Åæ„Åó„Åü`);
            } else {
                console.log(`üîá [${pageId}] Èü≥Â£∞Ê°àÂÜÖ„ÇíOFF„Å´„Åó„Åæ„Åó„Åü`);
            }
        }

        // Èü≥Â£∞UI„ÅÆÊõ¥Êñ∞
        function updateVoiceUI() {
            if (voiceEnabled) {
                soundToggle.classList.add('active');
                soundStatus.textContent = 'ON';
                soundStatus.className = 'sound-status enabled';
            } else {
                soundToggle.classList.remove('active');
                soundStatus.textContent = 'OFF';
                soundStatus.className = 'sound-status disabled';
            }
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì„Å´Âü∫„Å•„ÅèÈü≥Â£∞Ê°àÂÜÖÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâ
        function checkSessionNotifications(currentSessionTime, isPaused) {
            if (!voiceEnabled) return;

            const elapsedTime = 1200 - currentSessionTime; // ÁµåÈÅéÊôÇÈñìÔºàÁßíÔºâ
            
            // ÈÄöÁü•„Çø„Ç§„Éü„É≥„Ç∞ÔºàÁµåÈÅéÊôÇÈñì„Éô„Éº„ÇπÔºâ
            const notifications = [
                { time: 600, key: 'min10' },   // 10ÂàÜÁµåÈÅé
                { time: 900, key: 'min15' },   // 15ÂàÜÁµåÈÅé
                { time: 1020, key: 'min17' },  // 17ÂàÜÁµåÈÅé
                { time: 1080, key: 'min18' },  // 18ÂàÜÁµåÈÅé
                { time: 1140, key: 'min19' },  // 19ÂàÜÁµåÈÅé
                { time: 1200, key: 'min20' }   // 20ÂàÜÁµåÈÅé
            ];

            notifications.forEach(notification => {
                if (elapsedTime >= notification.time && !notifiedTimes.has(notification.time) && !isPaused) {
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ„Åß„ÅÆ„ÅøÈü≥Â£∞Ê°àÂÜÖ„ÇíÂÆüË°å
                    if (!isTabActive) {
                        console.log(`üò¥ [${pageId}] Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ„ÅÆ„Åü„ÇÅÈü≥Â£∞Ê°àÂÜÖ„Çí„Çπ„Ç≠„ÉÉ„Éó: ${notification.key}`);
                        notifiedTimes.add(notification.time); // ÈÄöÁü•Ê∏à„Åø„Å®„Åó„Å¶„Éû„Éº„ÇØ
                        return;
                    }
                    
                    const timeSinceActivity = Date.now() - lastActivityTime;
                    if (timeSinceActivity > 5000) { // 5Áßí‰ª•‰∏äÈùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ
                        console.log(`‚è∞ [${pageId}] Èùû„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÁä∂ÊÖã„ÅÆ„Åü„ÇÅÈü≥Â£∞Ê°àÂÜÖ„Çí„Çπ„Ç≠„ÉÉ„Éó: ${notification.key}`);
                        notifiedTimes.add(notification.time);
                        return;
                    }
                    
                    console.log(`üîî [${pageId}] Èü≥Â£∞Ê°àÂÜÖÂÆüË°å: ${notification.key} („Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„Éñ)`);
                    playAudioFile(notification.key);
                    notifiedTimes.add(notification.time);
                    
                    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
                    sessionTimerElement.classList.add('timer-pulse');
                    setTimeout(() => {
                        sessionTimerElement.classList.remove('timer-pulse');
                    }, 2000);
                }
            });
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÅÆÊ§úÂá∫ÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâ
        function checkSessionStart(currentStatus, previousStatus) {
            const timestamp = new Date().toLocaleTimeString();
            
            console.log(`üîç [${timestamp}] [${pageId}] „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÉÅ„Çß„ÉÉ„ÇØ:`);
            console.log(`   Èü≥Â£∞ÊúâÂäπ: ${voiceEnabled}`);
            console.log(`   ÂâçÂõû„Çπ„ÉÜ„Éº„Çø„Çπ: "${previousStatus}"`);
            console.log(`   ÁèæÂú®„Çπ„ÉÜ„Éº„Çø„Çπ: "${currentStatus}"`);
            console.log(`   „Çø„Éñ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ: ${isTabActive}`);
            console.log(`   ÊúÄÁµÇ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£: ${Math.floor((Date.now() - lastActivityTime) / 1000)}ÁßíÂâç`);
            
            // Ë§áÊï∞„Çø„Éñ„Åß„ÅÆÈáçË§á„Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßãÊ§úÂá∫„ÇíÈò≤Ê≠¢
            if (!checkTabSpecificSessionStart(currentStatus, previousStatus)) {
                return;
            }
            
            if (voiceEnabled && previousStatus === '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠' && currentStatus === 'ÂÆüË°å‰∏≠') {
                console.log(`üîî ‚úÖ [${pageId}] „Çø„Ç§„Éû„ÉºÈñãÂßã„ÇíÊ§úÂá∫„Åó„Åæ„Åó„ÅüÔºÅÔºà„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çø„ÉñÔºâ`);
                console.log(`üéµ [${pageId}] ÈñãÂßãÊ°àÂÜÖ„Éï„Ç°„Ç§„É´„ÇíÂÜçÁîü: counselor_start.wav`);
                
                // „Çø„Ç§„Éû„ÉºÈñãÂßãÊôÇ„ÅØÂøÖ„Åöcounselor_start.wav„ÇíÂÜçÁîü
                if (audioCache['start']) {
                    playAudioFile('start');
                } else {
                    console.log(`‚ö†Ô∏è [${pageId}] ÈñãÂßãÊ°àÂÜÖ„Éï„Ç°„Ç§„É´Êú™Ë™≠„ÅøËæº„Åø - Web Speech API„Åß‰ª£Êõø`);
                    if (requestAudioPlayback('start-speech')) {
                        speakJapanese(voiceMessages.start);
                    }
                }
                
                notifiedTimes.clear(); // ÈÄöÁü•Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢
                console.log(`üîÑ [${pageId}] ÈÄöÁü•Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü`);
            } else {
                if (!voiceEnabled) {
                    console.log(`üîá [${pageId}] Èü≥Â£∞ÁÑ°Âäπ„ÅÆ„Åü„ÇÅÈñãÂßãÊ°àÂÜÖ„Çí„Çπ„Ç≠„ÉÉ„Éó`);
                } else if (previousStatus !== '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠' || currentStatus !== 'ÂÆüË°å‰∏≠') {
                    console.log(`‚ùå [${pageId}] ÈñãÂßãÊù°‰ª∂‰∏ç‰∏ÄËá¥„ÅÆ„Åü„ÇÅÈñãÂßãÊ°àÂÜÖ„Çí„Çπ„Ç≠„ÉÉ„Éó`);
                }
            }
        }

        // ÊôÇÈñì„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        // „Çø„Ç§„Éû„ÉºÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateTimerDisplay(data) {
            const currentStatus = data.isPaused ? '‰∏ÄÊôÇÂÅúÊ≠¢‰∏≠' : 'ÂÆüË°å‰∏≠';
            
            // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥„ÅÆË©≥Á¥∞„É≠„Ç∞
            if (previousStatus !== currentStatus) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`üîÑ [${timestamp}] [${pageId}] „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥Ê§úÂá∫:`);
                console.log(`   ÂâçÂõû: "${previousStatus}" ‚Üí ‰ªäÂõû: "${currentStatus}"`);
                console.log(`   „Éá„Éº„Çø: isPaused=${data.isPaused}, sessionTime=${data.sessionTime}, totalTime=${data.totalTime}`);
                
                // „Çª„ÉÉ„Ç∑„Éß„É≥ÈñãÂßã„ÅÆÊ§úÂá∫
                checkSessionStart(currentStatus, previousStatus);
                
                previousStatus = currentStatus;
            }
            
            // „Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñìÂ§âÊõ¥„ÅÆË©≥Á¥∞„É≠„Ç∞
            if (data.sessionTime !== previousSessionTime) {
                const elapsedTime = 1200 - data.sessionTime;
                const elapsedMinutes = Math.floor(elapsedTime / 60);
                const elapsedSeconds = elapsedTime % 60;
                
                console.log(`‚è±Ô∏è „Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñìÂ§âÊõ¥: ${previousSessionTime}Áßí ‚Üí ${data.sessionTime}Áßí (ÁµåÈÅé: ${elapsedMinutes}ÂàÜ${elapsedSeconds}Áßí)`);
                
                checkSessionNotifications(data.sessionTime, data.isPaused);
                previousSessionTime = data.sessionTime;
            }
            
            // UIÊõ¥Êñ∞
            sessionTimerElement.textContent = formatTime(data.sessionTime);
            totalTimerElement.textContent = formatTime(data.totalTime);
            statusElement.textContent = `„Çπ„ÉÜ„Éº„Çø„Çπ: ${currentStatus}`;
        }

        // Êé•Á∂öÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
        function updateConnectionStatus(status) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`üì° [${timestamp}] [${pageId}] Áõ∏Ë´áÂì°„Éö„Éº„Ç∏ÔºöÊé•Á∂öÁä∂ÊÖãÊõ¥Êñ∞ -> ${status}`);
            
            connectionStatusElement.className = `connection-status ${status}`;
            connectionStatusElement.textContent = 
                status === 'connected' ? 'Êé•Á∂öÊ∏à„Åø' :
                status === 'connecting' ? 'Êé•Á∂ö‰∏≠...' : 'Êé•Á∂ö„Ç®„É©„Éº';
        }

        // APIÂëº„Å≥Âá∫„Åó
        async function fetchTimerState() {
            try {
                const startTime = Date.now();
                const response = await fetch('/api/timer');
                const fetchTime = Date.now() - startTime;
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // APIÂèñÂæó„ÅÆË©≥Á¥∞„É≠„Ç∞Ôºà3Áßí„Å´1Âõû„ÅÆ„ÅøÂá∫Âäõ„Åó„Å¶Ë≤†Ëç∑ËªΩÊ∏õÔºâ
                if (Math.floor(Date.now() / 3000) !== Math.floor((Date.now() - 1000) / 3000)) {
                    console.log(`üì° [${pageId}] APIÂèñÂæó (${fetchTime}ms): isPaused=${data.isPaused}, sessionTime=${data.sessionTime}, totalTime=${data.totalTime}`);
                }
                
                updateTimerDisplay(data);
                
                if (!isConnected) {
                    isConnected = true;
                    updateConnectionStatus('connected');
                    console.log(`üåê [${pageId}] Áõ∏Ë´áÂì°„Éö„Éº„Ç∏Ôºö„Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü`);
                }
                
                return data;
            } catch (error) {
                console.error(`‚ùå [${pageId}] Áõ∏Ë´áÂì°„Éö„Éº„Ç∏ APIÂèñÂæó„Ç®„É©„Éº:`, error);
                if (isConnected) {
                    isConnected = false;
                    updateConnectionStatus('error');
                }
                throw error;
            }
        }

        // „ÉÜ„Çπ„ÉàÈñ¢Êï∞
        function testVoice() {
            if (!voiceEnabled) {
                alert('Èü≥Â£∞Ê°àÂÜÖ„ÇíON„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            console.log(`üéôÔ∏è [${pageId}] Èü≥Â£∞„ÉÜ„Çπ„ÉàÂÆüË°å`);
            if (audioCache['soundCheck']) {
                playAudioFile('soundCheck');
            } else {
                speakJapanese("Èü≥Â£∞Ê°àÂÜÖ„Ç∑„Çπ„ÉÜ„É†„ÅÆ„ÉÜ„Çπ„Éà„Åß„Åô„ÄÇÁõ∏Ë´áÈñãÂßã„Åã„ÇâÁµÇ‰∫Ü„Åæ„Åß„ÄÅÈÅ©Âàá„Å™„Çø„Ç§„Éü„É≥„Ç∞„Åß„ÅîÊ°àÂÜÖ„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ");
            }
        }

        function showDebugInfo() {
            const loadedFiles = Object.keys(audioCache).filter(key => {
                const audio = audioCache[key];
                return audio && audio.readyState >= 3; // HAVE_FUTURE_DATA‰ª•‰∏ä
            });
            
            const timestamp = new Date().toLocaleString();
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const timeSinceActivity = Math.floor((Date.now() - lastActivityTime) / 1000);
            
            // ‰ªñ„ÅÆ„Çø„ÉñÊÉÖÂ†±„ÇíÂèñÂæó
            let otherTabsInfo = '‰∏çÊòé';
            try {
                const lockData = localStorage.getItem('sessiontimer_audio_lock');
                if (lockData) {
                    const lock = JSON.parse(lockData);
                    otherTabsInfo = `${lock.pageId} (${lock.audioType})`;
                } else {
                    otherTabsInfo = '„Å™„Åó';
                }
            } catch (e) {
                otherTabsInfo = 'localStorageÊú™ÂØæÂøú';
            }
            
            const info = `
üÜî „Éö„Éº„Ç∏ID: ${pageId}
üïê ÁèæÂú®ÊôÇÂàª: ${timestamp}
‚è∞ Á®ºÂÉçÊôÇÈñì: ${uptime}Áßí
üëÅÔ∏è „Çø„Éñ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ: ${isTabActive ? '„ÅØ„ÅÑ' : '„ÅÑ„ÅÑ„Åà'}
üï∞Ô∏è ÊúÄÁµÇ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£: ${timeSinceActivity}ÁßíÂâç
üîí Èü≥Â£∞„É≠„ÉÉ„ÇØÁä∂Ê≥Å: ${otherTabsInfo}
üéôÔ∏è Èü≥Â£∞Áä∂ÊÖã: ${voiceEnabled ? 'ON' : 'OFF'}
üîä Speech API: ${voiceReady ? 'ÂØæÂøú' : 'Êú™ÂØæÂøú'}
üìä ÂâçÂõû„Çπ„ÉÜ„Éº„Çø„Çπ: "${previousStatus || '„Å™„Åó'}"
‚è±Ô∏è ÂâçÂõû„Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì: ${previousSessionTime || '„Å™„Åó'}Áßí
üîî ÈÄöÁü•Â±•Ê≠¥: ${Array.from(notifiedTimes).join(', ') || '„Å™„Åó'}
üåê Êé•Á∂öÁä∂ÊÖã: ${isConnected ? 'Êé•Á∂öÊ∏à„Åø' : 'Êú™Êé•Á∂ö'}
üì± „É¶„Éº„Ç∂„Éº„Ç®„Éº„Ç∏„Çß„É≥„Éà: ${navigator.userAgent.includes('Mobile') ? '„É¢„Éê„Ç§„É´' : '„Éá„Çπ„ÇØ„Éà„ÉÉ„Éó'}
üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´: ${Object.keys(audioCache).length}ÂÄã‰∏≠${loadedFiles.length}ÂÄãË™≠„ÅøËæº„ÅøÊ∏à„Åø
üìÅ Ë™≠„ÅøËæº„ÅøÊ∏à„Åø„Éï„Ç°„Ç§„É´: ${loadedFiles.join(', ') || '„Å™„Åó'}
            `;
            alert(info);
            
            // „Ç≥„É≥„ÇΩ„Éº„É´„Å´„ÇÇË©≥Á¥∞ÊÉÖÂ†±„ÇíÂá∫Âäõ
            console.log(`üìä [${pageId}] Ë©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±:`);
            console.log(`üïê „Çø„Ç§„É†„Çπ„Çø„É≥„Éó: ${timestamp}`);
            console.log(`‚è∞ Á®ºÂÉçÊôÇÈñì: ${uptime}Áßí`);
            console.log(`üëÅÔ∏è „Çø„Éñ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ: ${isTabActive}`);
            console.log(`üï∞Ô∏è ÊúÄÁµÇ„Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£: ${timeSinceActivity}ÁßíÂâç`);
            console.log(`üîí Èü≥Â£∞„É≠„ÉÉ„ÇØÁä∂Ê≥Å: ${otherTabsInfo}`);
            console.log(`üìä ÂâçÂõû„Çπ„ÉÜ„Éº„Çø„Çπ: ${previousStatus}`);
            console.log(`‚è±Ô∏è ÂâçÂõû„Çª„ÉÉ„Ç∑„Éß„É≥ÊôÇÈñì: ${previousSessionTime}`);
            console.log(`üîî ÈÄöÁü•Â±•Ê≠¥: ${Array.from(notifiedTimes)}`);
            console.log(`üéµ Èü≥Â£∞„Éï„Ç°„Ç§„É´Ë©≥Á¥∞:`);
            Object.keys(audioCache).forEach(key => {
                const audio = audioCache[key];
                console.log(`  ${key}: readyState=${audio.readyState}, src=${audio.src}`);
            });
        }

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
        soundToggle.addEventListener('click', toggleVoice);

        // Èü≥Â£∞„É™„Çπ„Éà„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÇíÂæÖ„Å§
        speechSynthesis.onvoiceschanged = () => {
            initializeVoice();
        };

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂæå„ÅÆÂàùÊúüÂåñÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâ
        document.addEventListener('DOMContentLoaded', async () => {
            const timestamp = new Date().toLocaleString();
            console.log(`üì± [${timestamp}] [${pageId}] Áõ∏Ë´áÂì°„Éö„Éº„Ç∏ÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâË™≠„ÅøËæº„ÅøÂÆå‰∫Ü`);
            console.log(`üéØ [${pageId}] SessionTimerÈü≥Â£∞Ê©üËÉΩ‰ªò„ÅçÁõ∏Ë´áÂì°„Éö„Éº„Ç∏„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åô`);
            
            // Ë§áÊï∞„Çø„ÉñÂçîË™øÊ©üËÉΩ„ÅÆÂàùÊúüÂåñ
            initTabCoordination();
            console.log(`ü§ù [${pageId}] Ë§áÊï∞„Çø„ÉñÂçîË™øÊ©üËÉΩ„ÇíÂàùÊúüÂåñ`);
            
            // ÂàùÊúüÁä∂ÊÖã„ÅÆË®òÈå≤
            console.log(`üìä [${pageId}] ÂàùÊúüÁä∂ÊÖã:`);
            console.log(`   previousStatus: "${previousStatus}"`);
            console.log(`   previousSessionTime: ${previousSessionTime}`);
            console.log(`   voiceEnabled: ${voiceEnabled}`);
            console.log(`   isConnected: ${isConnected}`);
            console.log(`   isTabActive: ${isTabActive}`);
            
            // Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅÆ‰∫ãÂâçË™≠„ÅøËæº„Åø
            preloadAudioFiles();
            
            // Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†„ÅÆÊ∫ñÂÇô
            initializeVoice();
            updateVoiceUI();
            console.log(`üéôÔ∏è [${pageId}] Èü≥Â£∞„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñÂÆå‰∫Ü`);
            
            // ÂàùÊúü„Éá„Éº„ÇøÂèñÂæó
            updateConnectionStatus('connecting');
            try {
                console.log(`üåê [${pageId}] ÂàùÊúü„Éá„Éº„ÇøÂèñÂæó„ÇíÈñãÂßã`);
                await fetchTimerState();
                console.log(`‚úÖ [${pageId}] ÂàùÊúü„Éá„Éº„ÇøÂèñÂæóÊàêÂäü`);
            } catch (error) {
                console.error(`‚ùå [${pageId}] ÂàùÊúü„Éá„Éº„ÇøÂèñÂæóÂ§±Êïó:`, error);
            }
            
            // „Éù„Éº„É™„É≥„Ç∞ÈñãÂßã
            pollInterval = setInterval(async () => {
                try {
                    await fetchTimerState();
                    // „Ç¢„ÇØ„ÉÜ„Ç£„Éì„ÉÜ„Ç£ÊôÇÂàª„ÇíÊõ¥Êñ∞
                    if (isTabActive) {
                        lastActivityTime = Date.now();
                    }
                } catch (error) {
                    console.error(`‚ùå [${pageId}] „Éù„Éº„É™„É≥„Ç∞„Ç®„É©„Éº:`, error);
                }
            }, 1000);
            console.log(`üîÑ [${pageId}] 1ÁßíÈñìÈöî„Åß„ÅÆ„Éù„Éº„É™„É≥„Ç∞ÈñãÂßã`);
            
            console.log(`üöÄ [${new Date().toLocaleTimeString()}] [${pageId}] Áõ∏Ë´áÂì°„Éö„Éº„Ç∏ÔºàË§áÊï∞„Çø„ÉñÂØæÂøúÁâàÔºâ„ÅÆÂàùÊúüÂåñ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü`);
            
            // 5ÁßíÂæå„Å´Ë§áÊï∞„Çø„ÉñÁä∂Ê≥Å„Çí„É¨„Éù„Éº„Éà
            setTimeout(() => {
                try {
                    const lockData = localStorage.getItem('sessiontimer_audio_lock');
                    if (lockData) {
                        const lock = JSON.parse(lockData);
                        if (lock.pageId !== pageId) {
                            console.log(`üîç [${pageId}] ‰ªñ„ÅÆ„Çø„Éñ„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü: ${lock.pageId}`);
                        }
                    }
                } catch (e) {
                    console.log(`üìù [${pageId}] localStorageÂà©Áî®‰∏çÂèØ„ÄÅÂçòÁã¨Âãï‰Ωú„É¢„Éº„Éâ`);
                }
            }, 5000);
        });

        // „Éö„Éº„Ç∏Èõ¢ËÑ±ÊôÇ„ÅÆ„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
        window.addEventListener('beforeunload', () => {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>