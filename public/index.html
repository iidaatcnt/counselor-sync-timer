<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SessionTimer - ç›¸è«‡å“¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #43C6AC 0%, #191654 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
        }

        .header {
            padding: 20px;
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .connection-status {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 16px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .connected { 
            background: rgba(76, 175, 80, 0.9);
            border-color: rgba(76, 175, 80, 0.5);
        }
        .connecting { 
            background: rgba(255, 152, 0, 0.9);
            border-color: rgba(255, 152, 0, 0.5);
        }
        .error { 
            background: rgba(244, 67, 54, 0.9);
            border-color: rgba(244, 67, 54, 0.5);
        }

        .timer-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            text-align: center;
        }

        .session-timer {
            font-size: 5rem;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
            line-height: 1;
        }

        .session-label {
            font-size: 1.5rem;
            margin-bottom: 40px;
            opacity: 0.9;
        }

        .total-timer {
            font-size: 1.8rem;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .status-display {
            font-size: 1.2rem;
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 25px;
            display: inline-block;
        }

        /* éŸ³å£°é€šçŸ¥ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ */
        .sound-toggle-container {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
        }

        .toggle-switch {
            position: relative;
            width: 80px;
            height: 40px;
            background: #ccc;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .toggle-switch.active {
            background: #4CAF50;
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 32px;
            height: 32px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .toggle-switch.active .toggle-slider {
            transform: translateX(40px);
        }

        .sound-label {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .sound-status {
            font-size: 1.3rem;
            font-weight: bold;
            min-width: 80px;
        }

        .sound-status.enabled {
            color: #4CAF50;
        }

        .sound-status.disabled {
            color: #f44336;
        }

        /* éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
        .voice-message {
            margin: 20px 0;
            padding: 15px 25px;
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid rgba(76, 175, 80, 0.5);
            border-radius: 15px;
            font-size: 1.1rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.5s ease;
            max-width: 600px;
        }

        .voice-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ */
        .test-controls {
            padding: 30px 20px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .test-btn {
            margin: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .sound-test-btn {
            background: #FF6B35;
            color: white;
        }

        .voice-test-btn {
            background: #9B59B6;
            color: white;
        }

        .debug-btn {
            background: #3498DB;
            color: white;
        }

        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
        .timer-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 768px) {
            .session-timer {
                font-size: 3.5rem;
            }
            
            .session-label {
                font-size: 1.2rem;
            }
            
            .total-timer {
                font-size: 1.4rem;
            }
            
            .sound-toggle-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .toggle-switch {
                width: 70px;
                height: 35px;
            }
            
            .toggle-slider {
                width: 27px;
                height: 27px;
                top: 4px;
                left: 4px;
            }
            
            .toggle-switch.active .toggle-slider {
                transform: translateX(35px);
            }
        }

        @media (max-width: 480px) {
            .session-timer {
                font-size: 2.8rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">æ¥ç¶šä¸­...</div>
    
    <div class="header">
        <h1>ğŸ¯ SessionTimer - ç›¸è«‡å“¡</h1>
    </div>

    <div class="timer-display">
        <div class="session-timer" id="sessionTimer">20:00</div>
        <div class="session-label">ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
        <div class="total-timer">å…¨ä½“æ®‹ã‚Šæ™‚é–“: <span id="totalTimer">02:00:00</span></div>
        
        <div class="status-display">
            <span id="statusText">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ä¸€æ™‚åœæ­¢ä¸­</span>
        </div>

        <!-- éŸ³å£°é€šçŸ¥ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="sound-toggle-container">
            <span class="sound-label">ğŸ™ï¸ éŸ³å£°æ¡ˆå†…</span>
            <div class="toggle-switch" id="soundToggle">
                <div class="toggle-slider"></div>
            </div>
            <span class="sound-status disabled" id="soundStatus">OFF</span>
        </div>

        <!-- éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
        <div class="voice-message" id="voiceMessage"></div>
    </div>

    <div class="test-controls">
        <button class="test-btn voice-test-btn" onclick="testVoice()">ğŸ™ï¸ éŸ³å£°ãƒ†ã‚¹ãƒˆ</button>
        <button class="test-btn debug-btn" onclick="showDebugInfo()">ğŸ“Š ãƒ‡ãƒãƒƒã‚°æƒ…å ±</button>
    </div>

    <script>
        console.log('ğŸš€ SessionTimer ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
        
        // ãƒšãƒ¼ã‚¸ã®ä¸€æ„è­˜åˆ¥å­ã‚’ç”Ÿæˆï¼ˆè¤‡æ•°ã‚¿ãƒ–è­˜åˆ¥ç”¨ï¼‰
        const pageId = 'counselor-' + Math.random().toString(36).substr(2, 9);
        const startTime = Date.now();
        console.log(`ğŸ†” ãƒšãƒ¼ã‚¸ID: ${pageId}`);
        console.log(`ğŸ• èµ·å‹•æ™‚åˆ»: ${new Date().toLocaleString()}`);
        
        // è¤‡æ•°ã‚¿ãƒ–å¯¾å¿œã®ãŸã‚ã®å¤‰æ•°
        let isTabActive = true;
        let lastActivityTime = Date.now();
        let audioPlaybackLock = false;
        
        // DOMè¦ç´ ã®å–å¾—
        const totalTimerElement = document.getElementById('totalTimer');
        const sessionTimerElement = document.getElementById('sessionTimer');
        const statusElement = document.getElementById('statusText');
        const connectionStatusElement = document.getElementById('connectionStatus');
        const soundToggle = document.getElementById('soundToggle');
        const soundStatus = document.getElementById('soundStatus');
        const voiceMessageElement = document.getElementById('voiceMessage');
        
        // è¤‡æ•°ã‚¿ãƒ–å¯¾å¿œï¼šã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®ç›£è¦–
        function initTabCoordination() {
            // ã‚¿ãƒ–ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’ç›£è¦–
            document.addEventListener('visibilitychange', () => {
                isTabActive = !document.hidden;
                const timestamp = new Date().toLocaleTimeString();
                
                if (isTabActive) {
                    console.log(`ğŸ‘ï¸ [${timestamp}] [${pageId}] ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ`);
                    lastActivityTime = Date.now();
                } else {
                    console.log(`ğŸ˜´ [${timestamp}] [${pageId}] ã‚¿ãƒ–ãŒéã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ`);
                }
            });
            
            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ç›£è¦–
            window.addEventListener('focus', () => {
                isTabActive = true;
                lastActivityTime = Date.now();
                console.log(`ğŸ¯ [${pageId}] ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–å¾—`);
            });
            
            window.addEventListener('blur', () => {
                console.log(`ğŸ˜ [${pageId}] ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±`);
            });
        }
        
        // è¤‡æ•°ã‚¿ãƒ–å¯¾å¿œï¼šéŸ³å£°å†ç”Ÿæ¨©ã®ç®¡ç†
        function requestAudioPlayback(audioType) {
            const key = 'sessiontimer_audio_lock';
            const now = Date.now();
            
            try {
                // æ—¢å­˜ã®ãƒ­ãƒƒã‚¯çŠ¶æ³ç¢ºèª
                const existingLock = localStorage.getItem(key);
                if (existingLock) {
                    const lockData = JSON.parse(existingLock);
                    
                    // 5ç§’ä»¥å†…ã®ä»–ã®ã‚¿ãƒ–ã®ãƒ­ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã¯å†ç”Ÿã—ãªã„
                    if (lockData.timestamp > now - 5000 && lockData.pageId !== pageId) {
                        console.log(`ğŸ”’ [${pageId}] ä»–ã®ã‚¿ãƒ–ï¼ˆ${lockData.pageId}ï¼‰ãŒéŸ³å£°å†ç”Ÿä¸­ã®ãŸã‚ã€å†ç”Ÿã‚’ã‚¹ã‚­ãƒƒãƒ—`);
                        return false;
                    }
                }
                
                // éŸ³å£°å†ç”Ÿæ¨©ã‚’å–å¾—
                const lockData = {
                    pageId: pageId,
                    timestamp: now,
                    audioType: audioType,
                    isActive: isTabActive
                };
                
                localStorage.setItem(key, JSON.stringify(lockData));
                console.log(`ğŸ”“ [${pageId}] éŸ³å£°å†ç”Ÿæ¨©ã‚’å–å¾—: ${audioType}`);
                
                // 3ç§’å¾Œã«ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
                setTimeout(() => {
                    try {
                        const currentLock = localStorage.getItem(key);
                        if (currentLock) {
                            const currentData = JSON.parse(currentLock);
                            if (currentData.pageId === pageId && currentData.timestamp === now) {
                                localStorage.removeItem(key);
                                console.log(`ğŸ”“ [${pageId}] éŸ³å£°å†ç”Ÿãƒ­ãƒƒã‚¯ã‚’è§£é™¤`);
                            }
                        }
                    } catch (e) {
                        console.warn(`âš ï¸ [${pageId}] ãƒ­ãƒƒã‚¯è§£é™¤ã‚¨ãƒ©ãƒ¼:`, e);
                    }
                }, 3000);
                
                return true;
                
            } catch (error) {
                console.warn(`âš ï¸ [${pageId}] localStorageä½¿ç”¨ä¸å¯ã€éŸ³å£°å†ç”Ÿã‚’ç¶™ç¶š:`, error);
                return true; // localStorage ãŒä½¿ãˆãªã„å ´åˆã¯å†ç”Ÿã‚’è¨±å¯
            }
        }
        
        // è¤‡æ•°ã‚¿ãƒ–å¯¾å¿œï¼šé‡è¤‡ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ¤œå‡ºã®é˜²æ­¢
        function checkTabSpecificSessionStart(currentStatus, previousStatus) {
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã§ã®ã¿ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã‚’æ¤œå‡º
            if (!isTabActive && voiceEnabled) {
                console.log(`ğŸ˜´ [${pageId}] éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ãŸã‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ¤œå‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—`);
                return false;
            }
            
            // æœ€è¿‘ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒã‚ã‚‹ã‚¿ãƒ–ã®ã¿ã§å‡¦ç†
            const timeSinceActivity = Date.now() - lastActivityTime;
            if (timeSinceActivity > 10000) { // 10ç§’ä»¥ä¸Šéã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                console.log(`â° [${pageId}] é•·æ™‚é–“éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼ˆ${Math.floor(timeSinceActivity/1000)}ç§’ï¼‰ã®ãŸã‚ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ¤œå‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—`);
                return false;
            }
            
            return true;
        }
        let isConnected = false;
        let voiceEnabled = false;
        let previousSessionTime = null;
        let previousStatus = null;
        let notifiedTimes = new Set();

        // Web Speech API
        let speechSynthesis = window.speechSynthesis;
        let voiceReady = false;

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
        const audioFiles = {
            start: '/sounds/counselor_start.wav',
            min10: '/sounds/counselor_10min.wav',
            min15: '/sounds/counselor_15min.wav',
            min17: '/sounds/counselor_17min.wav',
            min18: '/sounds/counselor_18min.wav',
            min19: '/sounds/counselor_19min.wav',
            min20: '/sounds/counselor_end.wav',
            soundCheck: '/sounds/counselor_sound_check.wav'
        };

        // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿
        const voiceMessages = {
            start: "ã¾ã‚‚ãªãç›¸è«‡è€…ã•ã‚“ãŒã„ã‚‰ã£ã—ã‚ƒã„ã¾ã™ã€‚ç€å¸­ã—ã¦å¾…æ©Ÿã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",
            min10: "10åˆ†ãŒçµŒéã—ã¾ã—ãŸã€‚ç›¸è«‡ã®é€²è¡ŒçŠ¶æ³ã‚’ã”ç¢ºèªãã ã•ã„ã€‚",
            min15: "15åˆ†ãŒçµŒéã—ã¾ã—ãŸã€‚æ®‹ã‚Šæ™‚é–“ã¯5åˆ†ã§ã™ã€‚",
            min17: "æ®‹ã‚Šæ™‚é–“ã¯3åˆ†ã§ã™ã€‚ã¾ã¨ã‚ã®æº–å‚™ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚",
            min18: "æ®‹ã‚Šæ™‚é–“ã¯2åˆ†ã§ã™ã€‚",
            min19: "æ®‹ã‚Šæ™‚é–“ã¯1åˆ†ã§ã™ã€‚",
            min20: "ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚æœ€å¾Œã«å¿˜ã‚Œç‰©ãŒãªã„ã‹ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚ä¸æ˜ãªç‚¹ãŒã‚ã‚Œã°å—ä»˜ã«ã¦æ‰¿ã‚Šã¾ã™ã€‚",
            soundCheck: "éŸ³å£°æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ç›¸è«‡é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚"
        };

        // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®äº‹å‰èª­ã¿è¾¼ã¿
        const audioCache = {};
        
        function preloadAudioFiles() {
            console.log('ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®äº‹å‰èª­ã¿è¾¼ã¿ã‚’é–‹å§‹');
            
            Object.keys(audioFiles).forEach(key => {
                const audio = new Audio();
                audio.preload = 'auto';
                audio.src = audioFiles[key];
                audio.volume = 0.8;
                
                audio.addEventListener('canplaythrough', () => {
                    console.log(`âœ… éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†: ${key} (${audioFiles[key]})`);
                });
                
                audio.addEventListener('error', (e) => {
                    console.error(`âŒ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å¤±æ•—: ${key} (${audioFiles[key]})`, e);
                });
                
                // èª­ã¿è¾¼ã¿çŠ¶æ³ã‚’å®šæœŸãƒã‚§ãƒƒã‚¯
                audio.addEventListener('loadstart', () => {
                    console.log(`ğŸ”„ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹: ${key}`);
                });
                
                audioCache[key] = audio;
            });
            
            console.log(`ğŸµ ${Object.keys(audioFiles).length}å€‹ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã—ã¾ã—ãŸ`);
        }

        // WAVãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹éŸ³å£°å†ç”Ÿï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰
        function playAudioFile(key, callback = null) {
            if (!voiceEnabled) {
                console.log(`ğŸ”‡ [${pageId}] éŸ³å£°ç„¡åŠ¹ã®ãŸã‚å†ç”Ÿã‚’ã‚¹ã‚­ãƒƒãƒ—`);
                return;
            }

            // è¤‡æ•°ã‚¿ãƒ–ã§ã®éŸ³å£°å†ç”Ÿæ¨©ãƒã‚§ãƒƒã‚¯
            if (!requestAudioPlayback(key)) {
                console.log(`ğŸ”’ [${pageId}] éŸ³å£°å†ç”Ÿæ¨©ã‚’å–å¾—ã§ããªã„ãŸã‚ã€å†ç”Ÿã‚’ã‚¹ã‚­ãƒƒãƒ—: ${key}`);
                return;
            }

            const audio = audioCache[key];
            if (!audio) {
                console.error(`âŒ [${pageId}] éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«æœªç™»éŒ²: ${key}`);
                console.log(`ğŸ”„ [${pageId}] Web Speech APIã§ä»£æ›¿å†ç”Ÿ`);
                speakJapanese(voiceMessages[key], callback);
                return;
            }

            try {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤º
                showVoiceMessage(voiceMessages[key]);

                // éŸ³å£°å†ç”Ÿã®æº–å‚™
                audio.currentTime = 0; // æœ€åˆã‹ã‚‰å†ç”Ÿ
                
                // éŸ³é‡ç¢ºèª
                if (audio.volume < 0.5) {
                    audio.volume = 0.8;
                    console.log(`ğŸ”Š [${pageId}] éŸ³é‡ã‚’0.8ã«èª¿æ•´`);
                }
                
                const playPromise = audio.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log(`ğŸµ [${pageId}] éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿé–‹å§‹: ${key} (${audioFiles[key]})`);
                    }).catch((error) => {
                        console.error(`âŒ [${pageId}] éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿã‚¨ãƒ©ãƒ¼: ${key}`, error);
                        console.log(`ğŸ”„ [${pageId}] Web Speech APIã§ä»£æ›¿å†ç”Ÿ`);
                        speakJapanese(voiceMessages[key], callback);
                    });
                }

                audio.onended = () => {
                    console.log(`âœ… [${pageId}] éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿå®Œäº†: ${key}`);
                    if (callback) callback();
                };

            } catch (error) {
                console.error(`âŒ [${pageId}] éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿå¤±æ•—: ${key}`, error);
                console.log(`ğŸ”„ [${pageId}] Web Speech APIã§ä»£æ›¿å†ç”Ÿ`);
                speakJapanese(voiceMessages[key], callback);
            }
        }

        // éŸ³å£°åˆæˆã®åˆæœŸåŒ–
        function initializeVoice() {
            try {
                if ('speechSynthesis' in window) {
                    // æ—¥æœ¬èªéŸ³å£°ã®æº–å‚™
                    const voices = speechSynthesis.getVoices();
                    console.log('ğŸ™ï¸ åˆ©ç”¨å¯èƒ½ãªéŸ³å£°:', voices.length);
                    voiceReady = true;
                    return true;
                } else {
                    console.error('âŒ Web Speech API not supported');
                    return false;
                }
            } catch (error) {
                console.error('âŒ éŸ³å£°åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                return false;
            }
        }

        // æ—¥æœ¬èªéŸ³å£°ã®å†ç”Ÿï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰
        function speakJapanese(text, callback = null) {
            if (!voiceEnabled || !voiceReady) {
                console.log(`ğŸ”‡ [${pageId}] éŸ³å£°ç„¡åŠ¹ã¾ãŸã¯æœªå¯¾å¿œ`);
                return;
            }

            try {
                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”»é¢ã«è¡¨ç¤º
                showVoiceMessage(text);

                // éŸ³å£°åˆæˆ
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ja-JP';
                utterance.rate = 0.9; // å°‘ã—ã‚†ã£ãã‚Š
                utterance.pitch = 1.0;
                utterance.volume = 0.8;

                // æ—¥æœ¬èªéŸ³å£°ã‚’é¸æŠ
                const voices = speechSynthesis.getVoices();
                const japaneseVoice = voices.find(voice => voice.lang.includes('ja'));
                if (japaneseVoice) {
                    utterance.voice = japaneseVoice;
                }

                utterance.onstart = () => {
                    console.log(`ğŸ™ï¸ [${pageId}] Web Speech API éŸ³å£°å†ç”Ÿé–‹å§‹:`, text);
                };

                utterance.onend = () => {
                    console.log(`âœ… [${pageId}] Web Speech API éŸ³å£°å†ç”Ÿå®Œäº†`);
                    if (callback) callback();
                };

                utterance.onerror = (event) => {
                    console.error(`âŒ [${pageId}] Web Speech API éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:`, event.error);
                };

                speechSynthesis.speak(utterance);
            } catch (error) {
                console.error(`âŒ [${pageId}] Web Speech API éŸ³å£°å†ç”Ÿå¤±æ•—:`, error);
            }
        }

        // éŸ³å£°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç”»é¢è¡¨ç¤º
        function showVoiceMessage(text) {
            voiceMessageElement.textContent = text;
            voiceMessageElement.classList.add('show');
            
            // 5ç§’å¾Œã«éè¡¨ç¤º
            setTimeout(() => {
                voiceMessageElement.classList.remove('show');
            }, 5000);
        }

        // éŸ³å£°é€šçŸ¥ã®åˆ‡ã‚Šæ›¿ãˆ
        function toggleVoice() {
            voiceEnabled = !voiceEnabled;
            updateVoiceUI();
            
            if (voiceEnabled) {
                console.log(`ğŸ™ï¸ [${pageId}] éŸ³å£°æ¡ˆå†…ã‚’ONã«ã—ã¾ã—ãŸ`);
            } else {
                console.log(`ğŸ”‡ [${pageId}] éŸ³å£°æ¡ˆå†…ã‚’OFFã«ã—ã¾ã—ãŸ`);
            }
        }

        // éŸ³å£°UIã®æ›´æ–°
        function updateVoiceUI() {
            if (voiceEnabled) {
                soundToggle.classList.add('active');
                soundStatus.textContent = 'ON';
                soundStatus.className = 'sound-status enabled';
            } else {
                soundToggle.classList.remove('active');
                soundStatus.textContent = 'OFF';
                soundStatus.className = 'sound-status disabled';
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã«åŸºã¥ãéŸ³å£°æ¡ˆå†…ï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰
        function checkSessionNotifications(currentSessionTime, isPaused) {
            if (!voiceEnabled) return;

            const elapsedTime = 1200 - currentSessionTime; // çµŒéæ™‚é–“ï¼ˆç§’ï¼‰
            
            // é€šçŸ¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼ˆçµŒéæ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰
            const notifications = [
                { time: 600, key: 'min10' },   // 10åˆ†çµŒé
                { time: 900, key: 'min15' },   // 15åˆ†çµŒé
                { time: 1020, key: 'min17' },  // 17åˆ†çµŒé
                { time: 1080, key: 'min18' },  // 18åˆ†çµŒé
                { time: 1140, key: 'min19' },  // 19åˆ†çµŒé
                { time: 1200, key: 'min20' }   // 20åˆ†çµŒé
            ];

            notifications.forEach(notification => {
                if (elapsedTime >= notification.time && !notifiedTimes.has(notification.time) && !isPaused) {
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¿ãƒ–ã§ã®ã¿éŸ³å£°æ¡ˆå†…ã‚’å®Ÿè¡Œ
                    if (!isTabActive) {
                        console.log(`ğŸ˜´ [${pageId}] éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®ãŸã‚éŸ³å£°æ¡ˆå†…ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${notification.key}`);
                        notifiedTimes.add(notification.time); // é€šçŸ¥æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
                        return;
                    }
                    
                    const timeSinceActivity = Date.now() - lastActivityTime;
                    if (timeSinceActivity > 5000) { // 5ç§’ä»¥ä¸Šéã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                        console.log(`â° [${pageId}] éã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®ãŸã‚éŸ³å£°æ¡ˆå†…ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${notification.key}`);
                        notifiedTimes.add(notification.time);
                        return;
                    }
                    
                    console.log(`ğŸ”” [${pageId}] éŸ³å£°æ¡ˆå†…å®Ÿè¡Œ: ${notification.key} (ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–)`);
                    playAudioFile(notification.key);
                    notifiedTimes.add(notification.time);
                    
                    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
                    sessionTimerElement.classList.add('timer-pulse');
                    setTimeout(() => {
                        sessionTimerElement.classList.remove('timer-pulse');
                    }, 2000);
                }
            });
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã®æ¤œå‡ºï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰
        function checkSessionStart(currentStatus, previousStatus) {
            const timestamp = new Date().toLocaleTimeString();
            
            console.log(`ğŸ” [${timestamp}] [${pageId}] ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒã‚§ãƒƒã‚¯:`);
            console.log(`   éŸ³å£°æœ‰åŠ¹: ${voiceEnabled}`);
            console.log(`   å‰å›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: "${previousStatus}"`);
            console.log(`   ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: "${currentStatus}"`);
            console.log(`   ã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${isTabActive}`);
            console.log(`   æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£: ${Math.floor((Date.now() - lastActivityTime) / 1000)}ç§’å‰`);
            
            // è¤‡æ•°ã‚¿ãƒ–ã§ã®é‡è¤‡ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ¤œå‡ºã‚’é˜²æ­¢
            if (!checkTabSpecificSessionStart(currentStatus, previousStatus)) {
                return;
            }
            
            if (voiceEnabled && previousStatus === 'ä¸€æ™‚åœæ­¢ä¸­' && currentStatus === 'å®Ÿè¡Œä¸­') {
                console.log(`ğŸ”” âœ… [${pageId}] ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ï¼‰`);
                console.log(`ğŸµ [${pageId}] é–‹å§‹æ¡ˆå†…ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿ: counselor_start.wav`);
                
                // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹æ™‚ã¯å¿…ãšcounselor_start.wavã‚’å†ç”Ÿ
                if (audioCache['start']) {
                    playAudioFile('start');
                } else {
                    console.log(`âš ï¸ [${pageId}] é–‹å§‹æ¡ˆå†…ãƒ•ã‚¡ã‚¤ãƒ«æœªèª­ã¿è¾¼ã¿ - Web Speech APIã§ä»£æ›¿`);
                    if (requestAudioPlayback('start-speech')) {
                        speakJapanese(voiceMessages.start);
                    }
                }
                
                notifiedTimes.clear(); // é€šçŸ¥å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
                console.log(`ğŸ”„ [${pageId}] é€šçŸ¥å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
            } else {
                if (!voiceEnabled) {
                    console.log(`ğŸ”‡ [${pageId}] éŸ³å£°ç„¡åŠ¹ã®ãŸã‚é–‹å§‹æ¡ˆå†…ã‚’ã‚¹ã‚­ãƒƒãƒ—`);
                } else if (previousStatus !== 'ä¸€æ™‚åœæ­¢ä¸­' || currentStatus !== 'å®Ÿè¡Œä¸­') {
                    console.log(`âŒ [${pageId}] é–‹å§‹æ¡ä»¶ä¸ä¸€è‡´ã®ãŸã‚é–‹å§‹æ¡ˆå†…ã‚’ã‚¹ã‚­ãƒƒãƒ—`);
                }
            }
        }

        // æ™‚é–“ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (hours > 0) {
                return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            } else {
                return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
            }
        }

        // ã‚¿ã‚¤ãƒãƒ¼çŠ¶æ…‹ã®æ›´æ–°
        function updateTimerDisplay(data) {
            const currentStatus = data.isPaused ? 'ä¸€æ™‚åœæ­¢ä¸­' : 'å®Ÿè¡Œä¸­';
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´ã®è©³ç´°ãƒ­ã‚°
            if (previousStatus !== currentStatus) {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`ğŸ”„ [${timestamp}] [${pageId}] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ¤œå‡º:`);
                console.log(`   å‰å›: "${previousStatus}" â†’ ä»Šå›: "${currentStatus}"`);
                console.log(`   ãƒ‡ãƒ¼ã‚¿: isPaused=${data.isPaused}, sessionTime=${data.sessionTime}, totalTime=${data.totalTime}`);
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã®æ¤œå‡º
                checkSessionStart(currentStatus, previousStatus);
                
                previousStatus = currentStatus;
            }
            
            // ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“å¤‰æ›´ã®è©³ç´°ãƒ­ã‚°
            if (data.sessionTime !== previousSessionTime) {
                const elapsedTime = 1200 - data.sessionTime;
                const elapsedMinutes = Math.floor(elapsedTime / 60);
                const elapsedSeconds = elapsedTime % 60;
                
                console.log(`â±ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“å¤‰æ›´: ${previousSessionTime}ç§’ â†’ ${data.sessionTime}ç§’ (çµŒé: ${elapsedMinutes}åˆ†${elapsedSeconds}ç§’)`);
                
                checkSessionNotifications(data.sessionTime, data.isPaused);
                previousSessionTime = data.sessionTime;
            }
            
            // UIæ›´æ–°
            sessionTimerElement.textContent = formatTime(data.sessionTime);
            totalTimerElement.textContent = formatTime(data.totalTime);
            statusElement.textContent = `ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${currentStatus}`;
        }

        // æ¥ç¶šçŠ¶æ…‹ã®æ›´æ–°
        function updateConnectionStatus(status) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`ğŸ“¡ [${timestamp}] [${pageId}] ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ï¼šæ¥ç¶šçŠ¶æ…‹æ›´æ–° -> ${status}`);
            
            connectionStatusElement.className = `connection-status ${status}`;
            connectionStatusElement.textContent = 
                status === 'connected' ? 'æ¥ç¶šæ¸ˆã¿' :
                status === 'connecting' ? 'æ¥ç¶šä¸­...' : 'æ¥ç¶šã‚¨ãƒ©ãƒ¼';
        }

        // APIå‘¼ã³å‡ºã—
        async function fetchTimerState() {
            try {
                const startTime = Date.now();
                const response = await fetch('/api/timer');
                const fetchTime = Date.now() - startTime;
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                
                // APIå–å¾—ã®è©³ç´°ãƒ­ã‚°ï¼ˆ3ç§’ã«1å›ã®ã¿å‡ºåŠ›ã—ã¦è² è·è»½æ¸›ï¼‰
                if (Math.floor(Date.now() / 3000) !== Math.floor((Date.now() - 1000) / 3000)) {
                    console.log(`ğŸ“¡ [${pageId}] APIå–å¾— (${fetchTime}ms): isPaused=${data.isPaused}, sessionTime=${data.sessionTime}, totalTime=${data.totalTime}`);
                }
                
                updateTimerDisplay(data);
                
                if (!isConnected) {
                    isConnected = true;
                    updateConnectionStatus('connected');
                    console.log(`ğŸŒ [${pageId}] ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ï¼šã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã—ã¾ã—ãŸ`);
                }
                
                return data;
            } catch (error) {
                console.error(`âŒ [${pageId}] ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ APIå–å¾—ã‚¨ãƒ©ãƒ¼:`, error);
                if (isConnected) {
                    isConnected = false;
                    updateConnectionStatus('error');
                }
                throw error;
            }
        }

        // ãƒ†ã‚¹ãƒˆé–¢æ•°
        function testVoice() {
            if (!voiceEnabled) {
                alert('éŸ³å£°æ¡ˆå†…ã‚’ONã«ã—ã¦ãã ã•ã„');
                return;
            }
            console.log(`ğŸ™ï¸ [${pageId}] éŸ³å£°ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ`);
            if (audioCache['soundCheck']) {
                playAudioFile('soundCheck');
            } else {
                speakJapanese("éŸ³å£°æ¡ˆå†…ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ç›¸è«‡é–‹å§‹ã‹ã‚‰çµ‚äº†ã¾ã§ã€é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã”æ¡ˆå†…ã„ãŸã—ã¾ã™ã€‚");
            }
        }

        function showDebugInfo() {
            const loadedFiles = Object.keys(audioCache).filter(key => {
                const audio = audioCache[key];
                return audio && audio.readyState >= 3; // HAVE_FUTURE_DATAä»¥ä¸Š
            });
            
            const timestamp = new Date().toLocaleString();
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            const timeSinceActivity = Math.floor((Date.now() - lastActivityTime) / 1000);
            
            // ä»–ã®ã‚¿ãƒ–æƒ…å ±ã‚’å–å¾—
            let otherTabsInfo = 'ä¸æ˜';
            try {
                const lockData = localStorage.getItem('sessiontimer_audio_lock');
                if (lockData) {
                    const lock = JSON.parse(lockData);
                    otherTabsInfo = `${lock.pageId} (${lock.audioType})`;
                } else {
                    otherTabsInfo = 'ãªã—';
                }
            } catch (e) {
                otherTabsInfo = 'localStorageæœªå¯¾å¿œ';
            }
            
            const info = `
ğŸ†” ãƒšãƒ¼ã‚¸ID: ${pageId}
ğŸ• ç¾åœ¨æ™‚åˆ»: ${timestamp}
â° ç¨¼åƒæ™‚é–“: ${uptime}ç§’
ğŸ‘ï¸ ã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${isTabActive ? 'ã¯ã„' : 'ã„ã„ãˆ'}
ğŸ•°ï¸ æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£: ${timeSinceActivity}ç§’å‰
ğŸ”’ éŸ³å£°ãƒ­ãƒƒã‚¯çŠ¶æ³: ${otherTabsInfo}
ğŸ™ï¸ éŸ³å£°çŠ¶æ…‹: ${voiceEnabled ? 'ON' : 'OFF'}
ğŸ”Š Speech API: ${voiceReady ? 'å¯¾å¿œ' : 'æœªå¯¾å¿œ'}
ğŸ“Š å‰å›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: "${previousStatus || 'ãªã—'}"
â±ï¸ å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“: ${previousSessionTime || 'ãªã—'}ç§’
ğŸ”” é€šçŸ¥å±¥æ­´: ${Array.from(notifiedTimes).join(', ') || 'ãªã—'}
ğŸŒ æ¥ç¶šçŠ¶æ…‹: ${isConnected ? 'æ¥ç¶šæ¸ˆã¿' : 'æœªæ¥ç¶š'}
ğŸ“± ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ: ${navigator.userAgent.includes('Mobile') ? 'ãƒ¢ãƒã‚¤ãƒ«' : 'ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—'}
ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«: ${Object.keys(audioCache).length}å€‹ä¸­${loadedFiles.length}å€‹èª­ã¿è¾¼ã¿æ¸ˆã¿
ğŸ“ èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«: ${loadedFiles.join(', ') || 'ãªã—'}
            `;
            alert(info);
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
            console.log(`ğŸ“Š [${pageId}] è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ±:`);
            console.log(`ğŸ• ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${timestamp}`);
            console.log(`â° ç¨¼åƒæ™‚é–“: ${uptime}ç§’`);
            console.log(`ğŸ‘ï¸ ã‚¿ãƒ–ã‚¢ã‚¯ãƒ†ã‚£ãƒ–: ${isTabActive}`);
            console.log(`ğŸ•°ï¸ æœ€çµ‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£: ${timeSinceActivity}ç§’å‰`);
            console.log(`ğŸ”’ éŸ³å£°ãƒ­ãƒƒã‚¯çŠ¶æ³: ${otherTabsInfo}`);
            console.log(`ğŸ“Š å‰å›ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${previousStatus}`);
            console.log(`â±ï¸ å‰å›ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“: ${previousSessionTime}`);
            console.log(`ğŸ”” é€šçŸ¥å±¥æ­´: ${Array.from(notifiedTimes)}`);
            console.log(`ğŸµ éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«è©³ç´°:`);
            Object.keys(audioCache).forEach(key => {
                const audio = audioCache[key];
                console.log(`  ${key}: readyState=${audio.readyState}, src=${audio.src}`);
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        soundToggle.addEventListener('click', toggleVoice);

        // éŸ³å£°ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
        speechSynthesis.onvoiceschanged = () => {
            initializeVoice();
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã®åˆæœŸåŒ–ï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰
        document.addEventListener('DOMContentLoaded', async () => {
            const timestamp = new Date().toLocaleString();
            console.log(`ğŸ“± [${timestamp}] [${pageId}] ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰èª­ã¿è¾¼ã¿å®Œäº†`);
            console.log(`ğŸ¯ [${pageId}] SessionTimeréŸ³å£°æ©Ÿèƒ½ä»˜ãç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ã‚’åˆæœŸåŒ–ã—ã¾ã™`);
            
            // è¤‡æ•°ã‚¿ãƒ–å”èª¿æ©Ÿèƒ½ã®åˆæœŸåŒ–
            initTabCoordination();
            console.log(`ğŸ¤ [${pageId}] è¤‡æ•°ã‚¿ãƒ–å”èª¿æ©Ÿèƒ½ã‚’åˆæœŸåŒ–`);
            
            // åˆæœŸçŠ¶æ…‹ã®è¨˜éŒ²
            console.log(`ğŸ“Š [${pageId}] åˆæœŸçŠ¶æ…‹:`);
            console.log(`   previousStatus: "${previousStatus}"`);
            console.log(`   previousSessionTime: ${previousSessionTime}`);
            console.log(`   voiceEnabled: ${voiceEnabled}`);
            console.log(`   isConnected: ${isConnected}`);
            console.log(`   isTabActive: ${isTabActive}`);
            
            // éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã®äº‹å‰èª­ã¿è¾¼ã¿
            preloadAudioFiles();
            
            // éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ ã®æº–å‚™
            initializeVoice();
            updateVoiceUI();
            console.log(`ğŸ™ï¸ [${pageId}] éŸ³å£°ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†`);
            
            // åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—
            updateConnectionStatus('connecting');
            try {
                console.log(`ğŸŒ [${pageId}] åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—ã‚’é–‹å§‹`);
                await fetchTimerState();
                console.log(`âœ… [${pageId}] åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ`);
            } catch (error) {
                console.error(`âŒ [${pageId}] åˆæœŸãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—:`, error);
            }
            
            // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            pollInterval = setInterval(async () => {
                try {
                    await fetchTimerState();
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ™‚åˆ»ã‚’æ›´æ–°
                    if (isTabActive) {
                        lastActivityTime = Date.now();
                    }
                } catch (error) {
                    console.error(`âŒ [${pageId}] ãƒãƒ¼ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:`, error);
                }
            }, 1000);
            console.log(`ğŸ”„ [${pageId}] 1ç§’é–“éš”ã§ã®ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹`);
            
            console.log(`ğŸš€ [${new Date().toLocaleTimeString()}] [${pageId}] ç›¸è«‡å“¡ãƒšãƒ¼ã‚¸ï¼ˆè¤‡æ•°ã‚¿ãƒ–å¯¾å¿œç‰ˆï¼‰ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ`);
            
            // 5ç§’å¾Œã«è¤‡æ•°ã‚¿ãƒ–çŠ¶æ³ã‚’ãƒ¬ãƒãƒ¼ãƒˆ
            setTimeout(() => {
                try {
                    const lockData = localStorage.getItem('sessiontimer_audio_lock');
                    if (lockData) {
                        const lock = JSON.parse(lockData);
                        if (lock.pageId !== pageId) {
                            console.log(`ğŸ” [${pageId}] ä»–ã®ã‚¿ãƒ–ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ${lock.pageId}`);
                        }
                    }
                } catch (e) {
                    console.log(`ğŸ“ [${pageId}] localStorageåˆ©ç”¨ä¸å¯ã€å˜ç‹¬å‹•ä½œãƒ¢ãƒ¼ãƒ‰`);
                }
            }, 5000);
        });

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            if (speechSynthesis) {
                speechSynthesis.cancel();
            }
        });
    </script>
</body>
</html>