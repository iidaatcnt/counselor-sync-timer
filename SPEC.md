# SessionTimer 仕様書（更新版）

## 1. 概要
相談会や複数回のセッションを持つイベントの時間管理を支援するためのリアルタイムタイマーアプリケーション。
管理者ページからの操作が、閲覧者ページにリアルタイムに反映される。

## 2. 目的
- イベント全体の残り時間を可視化する。
- 各セッションの残り時間を明確にし、時間配分を円滑にする。
- 管理者と閲覧者の画面を分離し、シンプルな操作と安定した表示を提供する。

## 3. アーキテクチャ（更新版）
- **フロントエンド:** HTML, CSS, JavaScript
- **バックエンド:** Node.js, Express
- **通信方式:** REST API + ポーリング（Socket.IOから変更）
- **ホスティング:** Vercel

## 4. アーキテクチャ変更の経緯
**旧方式（Socket.IO）:**
- リアルタイム双方向通信
- Vercelのサーバーレス環境で接続が不安定
- 接続が切れるとタイマー状態がリセットされる問題

**新方式（REST API + ポーリング）:**
- サーバー側でタイマー状態をメモリ管理
- クライアント側で1秒ごとにAPIポーリング
- 接続が切れても状態が保持される
- Vercelのサーバーレス環境に適している

## 5. プロジェクト構造
```
sessiontimer/
├── server.js              # Express サーバー（API提供）
├── public/
│   ├── index.html         # 閲覧者ページ（ポーリング版）
│   └── admin.html         # 管理者ページ（API操作版）
├── package.json           # Node.js依存関係（expressのみ）
├── vercel.json           # Vercelデプロイ設定
├── SPEC.md               # この仕様書
└── README.md             # プロジェクト説明書
```

## 6. ページ構成
- **閲覧者ページ (`/index.html`):**
  - タイマーの表示のみを行うページ。操作ボタンはない。
  - `/api/timer` から1秒ごとにタイマー状態を取得（ポーリング）
- **管理者ページ (`/admin.html`):**
  - タイマーの表示と操作ボタンを持つページ。
  - ボタン操作により、各種POST APIを呼び出してタイマーを制御

## 7. 機能要件

### 7.1 タイマー仕様
- **全体タイマー (Total Timer):**
  - 初期値: `02:00:00` (7200秒)
  - 1秒ごとにカウントダウンする。
- **セッションタイマー (Session Timer):**
  - 初期値: `20:00` (1200秒)
  - 1秒ごとにカウントダウンする。
  - セッションタイマーが `00:00` になっても、自動ではリセットされない。`Next` ボタンで手動リセットする。

### 7.2 サーバー (server.js)
- **状態管理:**
  - サーバー側でタイマーの現在の状態（残り時間、一時停止状態、最終更新時刻）をメモリで管理する。
  - `timerState` オブジェクト: `{ totalTime, sessionTime, isPaused, lastUpdate }`
- **タイマーロジック:**
  - `setInterval` を使用して1秒ごとに状態を更新
  - 経過時間を計算してタイマーを減算する方式

### 7.3 API仕様（REST API）
- **GET `/api/timer`**: タイマー状態取得
  - Response: `{ totalTime, sessionTime, isPaused, totalTimeFormatted, sessionTimeFormatted, timestamp }`
- **POST `/api/timer/start`**: タイマーを開始（再開）する
- **POST `/api/timer/pause`**: タイマーを一時停止する
- **POST `/api/timer/reset`**: 全体タイマーとセッションタイマーを初期値にリセットし、停止する
- **POST `/api/timer/next`**: セッションタイマーのみを初期値にリセットする。全体タイマーは影響を受けない

### 7.4 クライアント側通信
- **閲覧者ページ:** 1秒ごとに `/api/timer` をポーリング
- **管理者ページ:** ボタン操作時にPOST API呼び出し + 1秒ごとのポーリング
- **接続状態表示:** API成功/失敗に応じて接続状態を表示

## 8. デプロイと設定 (Vercel)
- **`vercel.json`:**
  - 最小限の設定（Socket.IO関連の設定は削除済み）
- **依存関係:**
  - `express`: REST APIサーバー
  - Socket.IOは完全に削除済み

## 9. 現在の状況
- **デプロイ完了:** https://sessiontimer.vercel.app/
- **技術的課題:** 一部環境で接続状態が「接続中...」のまま停止する問題
- **デバッグ必要:** ブラウザ開発者ツールでのAPI通信確認

## 10. 画面レイアウト
- アプリケーションのタイトル。
- 全体タイマーの表示エリア。
- セッションタイマーの表示エリア。
- 接続状態表示（右上）。
- **管理者ページのみ:** `Start`, `Pause`, `Reset`, `Next` の4つの操作ボタンを配置したコントロールエリア。

## 11. 開発継続時の注意点
1. **Socket.IO関連コードは完全に削除済み**
2. **APIベースのポーリング方式に変更済み**
3. **HTMLファイルからSocket.IOのCDNリンクも削除必要**
4. **Vercelデプロイ時はserver.jsでmodule.exports = app**
5. **ローカル開発時は npm start でExpress起動**